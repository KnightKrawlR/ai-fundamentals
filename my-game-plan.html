<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Game Plan | AI Fundamentals</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/game-styles.css">
    <link rel="stylesheet" href="css/header-redesign.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add SF Pro font for Apple-like aesthetic -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    
    <!-- Add Tailwind CSS for the React app -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Mermaid JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      // Initialize Mermaid
      mermaid.initialize({ 
        startOnLoad: false, // We will render manually
        securityLevel: 'loose', // Required for some diagram features
        theme: 'default',
        flowchart: {
          htmlLabels: true,
          curve: 'linear',
          diagramPadding: 8
        },
        logLevel: 3 // Error level logging only
      });
      
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                200: '#bae6fd',
                300: '#7dd3fc',
                400: '#38bdf8',
                500: '#0ea5e9',
                600: '#0284c7',
                700: '#0369a1',
                800: '#075985',
                900: '#0c4a6e',
              },
            },
          },
        },
      }
    </script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>

    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>

    <style>
      /* Override styles for React components */
      #my-game-plan-root {
        min-height: 500px;
        padding: 20px 0;
      }
      
      /* Improved styles for Apple-like aesthetic */
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        color: #1a1a1a;
      }
      
      /* Fix for primary color classes */
      .bg-primary-500 {
        background-color: #0ea5e9;
      }
      .bg-primary-600 {
        background-color: #0284c7;
      }
      .bg-primary-700 {
        background-color: #0369a1;
      }
      .text-primary-600 {
        color: #0284c7;
      }
      .border-primary-500 {
        border-color: #0ea5e9;
      }
      .bg-primary-100 {
        background-color: #e0f2fe;
      }
      .bg-primary-50 {
        background-color: #f0f9ff;
      }
      
      /* Apple-like subtle transitions */
      .transition-all {
        transition: all 0.2s ease-in-out;
      }
      
      .shadow-subtle {
        box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.02);
      }
      
      .shadow-card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      }
      
      /* Apple-style button */
      .btn-apple {
        background-color: #0a84ff;
        color: white;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      
      .btn-apple:hover:not(:disabled) {
        background-color: #0060df;
        transform: translateY(-1px);
      }
      
      .btn-apple:active:not(:disabled) {
        transform: translateY(0);
      }
      
      .btn-apple:disabled {
        background-color: #b3d1ff;
        cursor: not-allowed;
      }
      
      /* Basic utility classes that might be missing */
      .flex { display: flex; }
      .flex-1 { flex: 1; }
      .flex-col { flex-direction: column; }
      .items-center { align-items: center; }
      .justify-center { justify-content: center; }
      .space-y-4 > * + * { margin-top: 1rem; }
      .min-h-\[500px\] { min-height: 500px; }
      .rounded-lg { border-radius: 0.5rem; }
      .rounded-md { border-radius: 0.375rem; }
      .rounded { border-radius: 0.25rem; }
      .p-4 { padding: 1rem; }
      .border { border-width: 1px; }
      
      /* Mermaid Diagram Styles */
      .mermaid-diagram-container {
        overflow-x: auto;
        margin: 20px 0;
      }
      
      .mermaid-diagram-render {
        display: flex;
        justify-content: center;
        margin: 0 auto;
        text-align: center;
      }
      
      /* Override Mermaid SVG styles for better visibility */
      .mermaid svg {
        max-width: 100%;
        height: auto !important;
        margin: 0 auto;
      }
      
      /* Style Mermaid diagram nodes and text */
      .mermaid .node rect, 
      .mermaid .node circle, 
      .mermaid .node ellipse, 
      .mermaid .node polygon {
        fill: #e0f2fe !important;
        stroke: #0284c7 !important;
      }
      
      .mermaid .edgePath .path {
        stroke: #64748b !important;
        stroke-width: 2px !important;
      }
      
      .mermaid .flowchart-link {
        stroke: #64748b !important;
        stroke-width: 2px !important;
      }
      
      .mermaid .label {
        color: #334155 !important;
      }

      /* User menu styles */
      .user-menu {
          position: relative;
          display: inline-block;
      }

      .user-menu-content {
          display: none;
          position: absolute;
          right: 0;
          background-color: white;
          min-width: 200px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          border-radius: 4px;
          padding: 8px 0;
          z-index: 1000;
      }

      .user-menu:hover .user-menu-content {
          display: block;
      }

      .user-menu-item {
          display: block;
          padding: 8px 16px;
          color: #333;
          text-decoration: none;
          transition: background-color 0.3s;
      }

      .user-menu-item:hover {
          background-color: #f5f5f5;
      }

      .user-menu-divider {
          height: 1px;
          background-color: #eee;
          margin: 8px 0;
      }

      .user-profile-btn {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 16px;
          border: none;
          background: none;
          cursor: pointer;
          color: white;
      }

      .user-avatar {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          background-color: #6c5ce7;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 500;
      }

      .sign-in-btn {
          display: flex;
          align-items: center;
          gap: 8px;
          color: white;
          background: none;
          border: none;
          cursor: pointer;
          font-size: 1rem;
          text-decoration: none;
      }

      .sign-in-btn i {
          font-size: 20px;
      }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <a href="/" class="logo">
                <i class="fas fa-brain"></i>
                <h1>AI Fundamentals</h1>
            </a>
            <nav>
                <ul>
                    <li><a href="/learning.html">Learning</a></li>
                    <li><a href="/ai-tools.html">AI Tools</a></li>
                    <li><a href="/premium.html">Premium</a></li>
                </ul>
            </nav>
            <div id="auth-container">
                <a href="login.html" class="sign-in-btn" id="sign-in-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Sign In</span>
                </a>
                <div class="user-menu" id="user-menu" style="display: none;">
                    <button class="user-profile-btn">
                        <div class="user-avatar" id="user-avatar"></div>
                        <span id="user-email"></span>
                    </button>
                    <div class="user-menu-content">
                        <a href="/account.html" class="user-menu-item">
                            <i class="fas fa-user"></i> My Account
                        </a>
                        <a href="/my-learning.html" class="user-menu-item">
                            <i class="fas fa-graduation-cap"></i> My Learning
                        </a>
                        <a href="/my-games.html" class="user-menu-item premium-item">
                            <i class="fas fa-gamepad"></i> My Games
                        </a>
                        <a href="/my-game-plan.html" class="user-menu-item premium-item">
                            <i class="fas fa-clipboard-list"></i> My Game Plan
                        </a>
                        <a href="/settings.html" class="user-menu-item">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <div class="user-menu-divider"></div>
                        <a href="#" class="user-menu-item" id="sign-out-btn">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            <div class="page-header mb-6"> 
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-3xl font-bold">My Game Plans</h1>
                    <button id="create-new-plan-btn" class="btn-apple py-2 px-4 flex items-center">
                        <i class="fas fa-plus mr-2"></i> Create New Plan
                    </button>
                </div>
                <p class="text-gray-600">Create, save, and refine AI implementation plans for your professional projects.</p> 
            </div>
            
            <div id="my-game-plan-root"></div>
            
            <!-- Fallback if React fails to load -->
            <div id="loading-fallback" style="display: flex; justify-content: center; align-items: center; height: 300px;">
                <div style="text-align: center;">
                    <div class="spinner" style="border: 4px solid rgba(0,0,0,.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #5D3FD3; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <p style="margin-top: 16px;">Loading Game Plan generator...</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>AI Fundamentals</h3>
                    <p>Your journey to AI mastery starts here</p>
                </div>
                <div class="footer-section">
                    <h3>Resources</h3>
                    <ul>
                        <li><a href="#">Flashcards</a></li>
                        <li><a href="#">Study Guides</a></li>
                        <li><a href="#">Video Lessons</a></li>
                        <li><a href="#">Practice Quizzes</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Company</h3>
                    <ul>
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Contact</a></li>
                        <li><a href="#">Careers</a></li>
                        <li><a href="#">Blog</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Legal</h3>
                    <ul>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Cookie Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 AI Fundamentals. All rights reserved.</p>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <!-- Auth Integration -->
    <script src="js/auth-integration.js"></script>
    <script src="js/stripe-integration.js"></script>
    <script src="js/access-control.js"></script>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjMisQkMgdA6qNg7gnXDumhNOOWOD-Y00",
            authDomain: "ai-fundamentals-ad37d.firebaseapp.com",
            projectId: "ai-fundamentals-ad37d",
            storageBucket: "ai-fundamentals-ad37d.appspot.com",
            messagingSenderId: "668115447112",
            appId: "1:668115447112:web:c0772e9f8c6a498737977d",
            measurementId: "G-2D5V39EQ3T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Auth state observer
        firebase.auth().onAuthStateChanged((user) => {
            const signInBtn = document.getElementById('sign-in-btn');
            const userMenu = document.getElementById('user-menu');
            const userAvatar = document.getElementById('user-avatar');
            const userEmail = document.getElementById('user-email');
            
            if (user) {
                // User is signed in
                console.log('User authenticated, proceeding to render Game Plan');
                signInBtn.style.display = 'none';
                userMenu.style.display = 'block';
                
                // Set user email and avatar
                userEmail.textContent = user.email;
                userAvatar.textContent = user.email[0].toUpperCase();
                
                // Update premium content visibility
                document.querySelectorAll('.premium-content').forEach(elem => {
                    elem.classList.add('unlocked');
                });
                
                // --- Render the React component ONLY if user is logged in ---
                renderGamePlanComponent(); 
                // ---------
            } else {
                // User is signed out
                console.log('User not authenticated, redirecting to login');
                signInBtn.style.display = 'flex';
                userMenu.style.display = 'none';
                
                // Update premium content visibility
                document.querySelectorAll('.premium-content').forEach(elem => {
                    elem.classList.remove('unlocked');
                });
                
                // Redirect to login page since this is a premium feature
                window.location.href = 'login.html?redirect=my-game-plan.html';
            }
        });

        // Sign out functionality
        document.getElementById('sign-out-btn').addEventListener('click', (e) => {
            e.preventDefault();
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Sign out error:', error);
            });
        });
        
        // Initialize user credits if needed
        function initializeUserCreditsIfNeeded(userId) {
            const db = firebase.firestore();
            
            // First check if user document exists
            db.collection('users').doc(userId).get().then((doc) => {
                if (!doc.exists) {
                    // Create the user document first with initial data
                    return db.collection('users').doc(userId).set({
                        credits: 10, // Initial credits for new users
                    });
                }
            }).catch((error) => {
                console.error('Error checking/initializing user credits:', error);
            });
        }
    </script>

    <!-- Make Firebase available to the React app -->
    <script>
        // Make Firebase accessible to the React component
        window.firebase = firebase;
        
        // Add debugging info
        console.log('Firebase initialized:', typeof firebase !== 'undefined');
        console.log('React available:', typeof React !== 'undefined');
        console.log('ReactDOM available:', typeof ReactDOM !== 'undefined');
        
        // Clear any inline React components to avoid conflicts
        window.addEventListener('DOMContentLoaded', function() {
          try {
            const rootElement = document.getElementById('my-game-plan-root');
            if (rootElement) {
              // Remove any existing content to ensure a clean mount
              rootElement.innerHTML = '';
            }
          } catch (error) {
            console.error('Error clearing root element:', error);
          }
        });
    </script>

    <!-- Game Plan Component - Inline Script -->
    <script>
      // Function to render the Game Plan component
      function renderGamePlanComponent() {
          console.log("Attempting to render Game Plan component...");
      
          // Verify React and ReactDOM are available
          if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
            console.error('React or ReactDOM is not available!');
            return;
          }
          
          // Check if component already rendered (prevent double render)
          const rootElement = document.getElementById('my-game-plan-root');
          if (rootElement && rootElement.hasChildNodes()) {
              console.log("Game Plan component already rendered.");
              return;
          }

          // Simple Game Plan Component with three dropdowns
          function GamePlanApp() {
            // State hooks for form inputs
            const [selectedTopic, setSelectedTopic] = React.useState('');
            const [selectedChallenge, setSelectedChallenge] = React.useState('');
            const [selectedProjectType, setSelectedProjectType] = React.useState('');
            const [description, setDescription] = React.useState('');
            
            // State for API interaction
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [gamePlanResult, setGamePlanResult] = React.useState(null);
            
            // New state for revision functionality
            const [revisionText, setRevisionText] = React.useState('');
            const [isRevising, setIsRevising] = React.useState(false);
            const [revisionHistory, setRevisionHistory] = React.useState([]);
            
            // New state for saved game plans
            const [savedGamePlans, setSavedGamePlans] = React.useState([]);
            const [selectedPlanId, setSelectedPlanId] = React.useState(null);
            const [viewMode, setViewMode] = React.useState('create'); // 'create' or 'view'
            const [aiResponse, setAiResponse] = React.useState(null);
            const [aiQuestion, setAiQuestion] = React.useState(null);
            const [isSaving, setIsSaving] = React.useState(false);
            
            // State for form collapse (starts open)
            const [isFormCollapsed, setIsFormCollapsed] = React.useState(false);

            // State for collapsible sections (true = open)
            const [sectionsOpen, setSectionsOpen] = React.useState({});

            // Function to ensure user document exists before accessing gamePlans
            const ensureUserDocumentExists = async (userId) => {
              try {
                const db = firebase.firestore();
                console.log("Ensuring user document exists for:", userId);
                
                // Get the user document
                const userRef = db.collection('users').doc(userId);
                const userDoc = await userRef.get();
                
                // If user document doesn't exist, create it with default values
                if (!userDoc.exists) {
                  console.log("Creating user document for:", userId);
                  await userRef.set({
                    credits: 10,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                  });
                  console.log("User document created successfully");
                  return true;
                }
                
                console.log("User document already exists");
                return true;
              } catch (error) {
                console.error("Error ensuring user document exists:", error);
                return false;
              }
            };

            // Load saved game plans on component mount
            React.useEffect(() => {
              if (window.firebase && firebase.auth().currentUser) {
                const userId = firebase.auth().currentUser.uid;
                
                // First ensure the user document exists
                ensureUserDocumentExists(userId).then(success => {
                  if (success) {
                    const db = firebase.firestore();
                    console.log("Attempting to load saved game plans for user:", userId);
                    
                    // Use a simple get() instead of onSnapshot to debug
                    try {
                      db.collection('users').doc(userId)
                        .collection('gamePlans')
                        .get()
                        .then(snapshot => {
                          const plans = [];
                          snapshot.forEach((doc) => {
                            plans.push({
                              id: doc.id,
                              ...doc.data()
                            });
                          });
                          setSavedGamePlans(plans);
                          console.log('Loaded saved game plans:', plans);
                        })
                        .catch(error => {
                          console.error('Error loading saved game plans:', error);
                          setError('Unable to load saved plans: ' + error.message);
                        });
                    } catch (err) {
                      console.error("Error setting up game plans loader:", err);
                      setError('Error setting up plan loader: ' + err.message);
                    }
                  }
                });
              }
            }, []);

            // Helper function to generate a title for the game plan
            const generatePlanTitle = () => {
              if (!gamePlanResult) return 'New Game Plan';
              
              // Generate from topics
              const topicPart = selectedTopic || '';
              const challengePart = selectedChallenge || '';
              
              if (gamePlanResult.project_summary) {
                // Extract a title from the project summary
                const summaryWords = gamePlanResult.project_summary.split(' ').slice(0, 6).join(' ');
                return `${summaryWords}${summaryWords.endsWith('.') ? '' : '...'}`;
              }
              
              return topicPart && challengePart 
                ? `${topicPart}: ${challengePart}` 
                : (topicPart || challengePart || 'Untitled Game Plan');
            };
            
            // Handle form submission with better error handling
            const handleSubmit = async (e) => {
              if (e) e.preventDefault();
              console.log("Form submission started");
              console.log("Current form values:", { topic: selectedTopic, challenge: selectedChallenge, projectType: selectedProjectType });
              
              setIsLoading(true);
              setError(null);
              
              // Store previous plan in history if it exists
              if (gamePlanResult) {
                setRevisionHistory(prev => [...prev, {
                  plan: gamePlanResult,
                  revisionPrompt: null, // No revision prompt for initial plan
                  timestamp: new Date().toISOString()
                }]);
              }
              
              setGamePlanResult(null);
              setAiQuestion(null);
              setAiResponse(null);
              
              // First ensure the user document exists
              if (window.firebase && firebase.auth().currentUser) {
                try {
                  const userId = firebase.auth().currentUser.uid;
                  console.log("Authenticated user ID:", userId);
                  
                  await ensureUserDocumentExists(userId);
                  console.log("User document confirmed");
                  
                  // Construct the data object to send to the function
                  const requestData = {
                    topic: selectedTopic,
                    challenge: selectedChallenge,
                    projectType: selectedProjectType,
                    projectDescription: description || ''
                  };
                  
                  console.log("Calling generateGamePlan with data:", requestData);
                  
                  // Ensure Firebase functions is available
                  if (!window.firebase || !window.firebase.functions) {
                    throw new Error("Firebase Functions SDK is not available.");
                  }
                  
                  // Ensure user is authenticated
                  if (!firebase.auth().currentUser) {
                    throw new Error("User is not authenticated. Please sign in again.");
                  }
                  
                  try {
                    console.log("About to call Firebase function");
                    // Call the generateGamePlan function
                    const actualGamePlanFunction = firebase.functions().httpsCallable('generateGamePlan');
                    console.log("Firebase function retrieved:", actualGamePlanFunction);
                    
                    const result = await actualGamePlanFunction(requestData);
                    console.log("Received response from generateGamePlan function:", result);
                    
                    if (result.data && typeof result.data === 'object') {
                      console.log("Setting game plan result:", result.data);
                      setGamePlanResult(result.data);
                      
                      // Manually save the game plan to Firestore
                      try {
                        // Generate a title from the project summary
                        let planTitle = 'Game Plan';
                        if (result.data.project_summary) {
                          const words = result.data.project_summary.split(' ').slice(0, 6).join(' ');
                          planTitle = `${words}${words.endsWith('.') ? '' : '...'}`;
                        } else if (selectedTopic && selectedChallenge) {
                          planTitle = `${selectedTopic}: ${selectedChallenge}`;
                        } else if (selectedTopic) {
                          planTitle = selectedTopic;
                        }
                        
                        // Save to Firestore directly
                        const db = firebase.firestore();
                        const userDocRef = db.collection('users').doc(userId);
                        
                        // Create planData object
                        const planData = {
                          title: planTitle,
                          topic: selectedTopic || '',
                          challenge: selectedChallenge || '',
                          projectType: selectedProjectType || '',
                          description: description || '',
                          plan: result.data,
                          revisionHistory: [],
                          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // Save to Firestore and update state with the new plan
                        const docRef = await userDocRef.collection('gamePlans').add(planData);
                        console.log('Manually saved game plan with ID:', docRef.id);
                        
                        // Reload saved plans after adding a new one
                        const plansSnapshot = await userDocRef.collection('gamePlans').get();
                        const updatedPlans = [];
                        plansSnapshot.forEach(doc => {
                          updatedPlans.push({
                            id: doc.id,
                            ...doc.data()
                          });
                        });
                        
                        // Update the plans in state
                        setSavedGamePlans(updatedPlans);
                        setSelectedPlanId(docRef.id);
                        setViewMode('view');
                      } catch (saveError) {
                        console.error('Error saving game plan:', saveError);
                      }
                    } else {
                      console.error("Invalid response structure:", result);
                      throw new Error(result.data?.error || result.data || 'Invalid response structure from function.');
                    }
                  } catch (functionError) {
                    console.error("Firebase function error:", functionError);
                    throw functionError;
                  }
                } catch (err) {
                  console.error("Error calling generateGamePlan:", err);
                  console.error("Error details:", err.code, err.message, err.details);
                  
                  // Enhanced error messages for common issues
                  if (err.code === 'permission-denied' || err.message?.includes('permission')) {
                    setError('Permission denied. Please check that you are properly signed in and have sufficient credits.');
                  } else if (err.code === 'resource-exhausted') {
                    setError('You do not have enough credits to generate a game plan. Please purchase more credits.');
                  } else {
                    setError(err.message || 'Failed to generate game plan. Please try again.');
                  }
                } finally {
                  setIsLoading(false);
                  console.log("Form submission completed");
                }
              } else {
                console.error("No authenticated user found");
                setError('You must be signed in to create a game plan.');
                setIsLoading(false);
              }
            };
            
            // Handle selecting a saved game plan
            const handleSelectPlan = (planId) => {
              if (!planId || planId === 'new') {
                // Reset to create mode
                setSelectedPlanId(null);
                setViewMode('create');
                setGamePlanResult(null);
                setRevisionHistory([]);
                setSelectedTopic('');
                setSelectedChallenge('');
                setSelectedProjectType('');
                setDescription('');
                setIsFormCollapsed(false);
                return;
              }
              
              const selectedPlan = savedGamePlans.find(p => p.id === planId);
              if (!selectedPlan) return;
              
              setSelectedPlanId(planId);
              setViewMode('view');
              setGamePlanResult(selectedPlan.plan);
              setRevisionHistory(selectedPlan.revisionHistory || []);
              setSelectedTopic(selectedPlan.topic || '');
              setSelectedChallenge(selectedPlan.challenge || '');
              setSelectedProjectType(selectedPlan.projectType || '');
              setDescription(selectedPlan.description || '');
              setIsFormCollapsed(true);
            };
            
            // Handle revision submission with AI agent-like interaction
            const handleRevision = async (e) => {
              e.preventDefault();
              if (!revisionText.trim()) return;
              
              setIsRevising(true);
              setError(null);
              setAiResponse(null);
              
              // Store current plan in history
              setRevisionHistory(prev => [...prev, {
                plan: gamePlanResult,
                revisionPrompt: revisionText,
                timestamp: new Date().toISOString()
              }]);
              
              // Construct the data object with revision info
              const requestData = {
                topic: selectedTopic,
                challenge: selectedChallenge,
                projectType: selectedProjectType,
                projectDescription: description || '',
                previousPlan: JSON.stringify(gamePlanResult),
                revisionRequest: revisionText
              };
              
              console.log("Calling generateGamePlan with revision:", requestData);
              
              try {
                // Existing function call code...
                // ...
                
                // Check if the AI has a question before proceeding
                if (result.data && result.data.ai_question) {
                  // AI has a clarifying question
                  setAiQuestion(result.data.ai_question);
                  setGamePlanResult(null); // Don't update the plan yet
                } else if (result.data && typeof result.data === 'object') {
                  setGamePlanResult(result.data);
                  setRevisionText(''); // Clear the revision input
                  setAiQuestion(null); // Clear any previous questions
                  
                  // If this was a specific response to a previous question
                  if (aiQuestion) {
                    setAiResponse("I've updated the plan based on your answer.");
                    setTimeout(() => {
                      setAiResponse(null);
                    }, 5000);
                  }
                  
                  // If we're in view mode, auto-save the update
                  if (viewMode === 'view' && selectedPlanId) {
                    handleSavePlan();
                  }
                } else {
                  throw new Error(result.data?.error || result.data || 'Invalid response structure from function.');
                }
              } catch (err) {
                console.error("Error calling revision:", err);
                setError(err.message || 'Failed to revise game plan. Please try again.');
              } finally {
                setIsRevising(false);
              }
            };
            
            // Handle answering AI clarifying questions
            const handleAnswerQuestion = async (answer) => {
              if (!aiQuestion) return;
              
              setIsRevising(true);
              setError(null);
              
              const requestData = {
                topic: selectedTopic,
                challenge: selectedChallenge,
                projectType: selectedProjectType,
                projectDescription: description || '',
                previousPlan: JSON.stringify(gamePlanResult),
                revisionRequest: revisionText,
                aiQuestion: aiQuestion,
                aiAnswer: answer
              };
              
              console.log("Answering AI question:", requestData);
              
              try {
                // Similar function call as handleRevision
                // ...
                
                if (result.data && typeof result.data === 'object') {
                  setGamePlanResult(result.data);
                  setRevisionText(''); // Clear the revision input
                  setAiQuestion(null); // Clear the question
                  
                  setAiResponse("Thank you! I've updated the plan based on your answer.");
                  setTimeout(() => {
                    setAiResponse(null);
                  }, 5000);
                  
                  // If we're in view mode, auto-save the update
                  if (viewMode === 'view' && selectedPlanId) {
                    handleSavePlan();
                  }
                } else {
                  throw new Error(result.data?.error || result.data || 'Invalid response structure from function.');
                }
              } catch (err) {
                console.error("Error answering AI question:", err);
                setError(err.message || 'Failed to process your answer. Please try again.');
              } finally {
                setIsRevising(false);
              }
            };
            
            // Delete a saved game plan
            const handleDeletePlan = async (planId) => {
              if (!planId || !window.firebase || !firebase.auth().currentUser) return;
              
              if (!confirm('Are you sure you want to delete this game plan? This action cannot be undone.')) {
                return;
              }
              
              try {
                const userId = firebase.auth().currentUser.uid;
                const db = firebase.firestore();
                
                await db.collection('users').doc(userId)
                  .collection('gamePlans')
                  .doc(planId)
                  .delete();
                  
                console.log('Deleted game plan:', planId);
                
                // If the deleted plan was selected, reset to create mode
                if (selectedPlanId === planId) {
                  handleSelectPlan('new');
                }
              } catch (error) {
                console.error('Error deleting game plan:', error);
                setError('Failed to delete game plan: ' + error.message);
              }
            };

            // Handle saving the current game plan
            const handleSavePlan = async () => {
              if (!gamePlanResult || !window.firebase || !firebase.auth().currentUser) return;
              
              setIsSaving(true);
              
              try {
                const userId = firebase.auth().currentUser.uid;
                await ensureUserDocumentExists(userId);
                const db = firebase.firestore();
                
                const planData = {
                  title: generatePlanTitle(),
                  topic: selectedTopic,
                  challenge: selectedChallenge,
                  projectType: selectedProjectType,
                  description: description,
                  plan: gamePlanResult,
                  revisionHistory: revisionHistory,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // If we're in view mode, update the existing plan
                if (viewMode === 'view' && selectedPlanId) {
                  await db.collection('users').doc(userId)
                    .collection('gamePlans')
                    .doc(selectedPlanId)
                    .update({
                      plan: gamePlanResult,
                      revisionHistory: revisionHistory,
                      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                  console.log('Updated existing game plan:', selectedPlanId);
                } else {
                  // Create a new plan
                  const docRef = await db.collection('users').doc(userId)
                    .collection('gamePlans')
                    .add(planData);
                    
                  setSelectedPlanId(docRef.id);
                  setViewMode('view');
                  console.log('Saved new game plan:', docRef.id);
                }
                
                // Reload saved plans
                const plansSnapshot = await db.collection('users').doc(userId)
                  .collection('gamePlans')
                  .get();
                
                const updatedPlans = [];
                plansSnapshot.forEach(doc => {
                  updatedPlans.push({
                    id: doc.id,
                    ...doc.data()
                  });
                });
                
                setSavedGamePlans(updatedPlans);
              } catch (error) {
                console.error('Error saving game plan:', error);
                setError('Failed to save game plan: ' + error.message);
              } finally {
                setIsSaving(false);
              }
            };

            // Render function
            return React.createElement('div', {
              className: 'max-w-4xl mx-auto p-5 font-sans'
            }, [
              // Game Plan History Selector - NEW COMPONENT
              React.createElement('div', {
                className: 'mb-6 bg-white border border-gray-200 rounded-lg shadow-card transition-all p-6'
              }, [
                // Current Plan Title Display
                gamePlanResult && React.createElement('div', {
                  className: 'mb-4'
                }, [
                  React.createElement('h2', {
                    className: 'text-xl font-semibold text-gray-800'
                  }, viewMode === 'view' ? 
                     (savedGamePlans.find(p => p.id === selectedPlanId)?.title || 'Game Plan') : 
                     generatePlanTitle()),
                  React.createElement('div', {
                    className: 'flex items-center space-x-2 mt-2'
                  }, [
                    // Save button - only show if not saved or if modified
                    (viewMode === 'create' || (viewMode === 'view' && revisionHistory.length > 0)) && 
                      React.createElement('button', {
                        onClick: handleSavePlan,
                        disabled: isSaving || !gamePlanResult,
                        className: 'btn-apple py-1 px-3 text-sm flex items-center'
                      }, [
                        React.createElement('i', { className: 'fas fa-save mr-1' }),
                        isSaving ? 'Saving...' : (viewMode === 'view' ? 'Update' : 'Save Plan')
                      ]),
                    
                    // If viewing a saved plan, show delete button
                    viewMode === 'view' && React.createElement('button', {
                      onClick: () => handleDeletePlan(selectedPlanId),
                      className: 'bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded text-sm flex items-center'
                    }, [
                      React.createElement('i', { className: 'fas fa-trash-alt mr-1' }),
                      'Delete'
                    ])
                  ])
                ]),
                
                // Game Plan History Dropdown
                React.createElement('div', {
                  className: 'flex items-center space-x-2'
                }, [
                  React.createElement('label', {
                    htmlFor: 'game-plan-history',
                    className: 'font-medium text-gray-700'
                  }, 'Your Game Plans:'),
                  React.createElement('select', {
                    id: 'game-plan-history',
                    value: selectedPlanId || 'new',
                    onChange: (e) => handleSelectPlan(e.target.value),
                    className: 'flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all'
                  }, [
                    React.createElement('option', { value: 'new' }, 'Create New Game Plan'),
                    React.createElement('optgroup', { label: 'Your Saved Plans' }, 
                      savedGamePlans.length > 0 
                        ? savedGamePlans.map(plan => 
                            React.createElement('option', { 
                              key: plan.id, 
                              value: plan.id 
                            }, plan.title || 'Untitled Plan')
                          )
                        : [React.createElement('option', { 
                            value: '', 
                            disabled: true 
                          }, 'No saved plans yet')]
                    )
                  ])
                ])
              ]),
              
              // Form Section (Now labeled "Create" or "Revise" based on mode)
              React.createElement('div', { 
                className: 'mb-8 p-6 bg-white border border-gray-200 rounded-lg shadow-card transition-all' 
              }, [
                React.createElement('button', { 
                  className: 'w-full text-left text-2xl font-semibold text-gray-800 mb-4 flex justify-between items-center focus:outline-none hover:text-blue-600 transition-colors', 
                  onClick: () => setIsFormCollapsed(!isFormCollapsed)
                }, [
                  viewMode === 'create' ? 'Create New Game Plan' : 'Revise Game Plan',
                  React.createElement('i', { 
                    className: `fas fa-chevron-down transition-transform duration-200 ${isFormCollapsed ? '' : 'rotate-180'}` 
                  })
                ]),
                
                // Always show form when in create mode and no saved plans
                (!isFormCollapsed || (viewMode === 'create' && savedGamePlans.length === 0)) && React.createElement('form', {
                  onSubmit: handleSubmit,
                  className: 'flex flex-col space-y-5'
                }, [
                  // Topic dropdown
                  React.createElement('div', {}, [
                    React.createElement('label', {
                      htmlFor: 'topic',
                      className: 'block mb-2 font-medium text-gray-700'
                    }, 'Topic'),
                    React.createElement('select', {
                      id: 'topic',
                      value: selectedTopic,
                      onChange: (e) => setSelectedTopic(e.target.value),
                      className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all'
                    }, [
                      React.createElement('option', { value: '' }, 'Select a topic'),
                      ...['Introduction to AI', 'Office Productivity', 'Personal Finance', 'Social Media Marketing', 'Videography', 'eCommerce'].map(topic => 
                        React.createElement('option', { key: topic, value: topic }, topic)
                      )
                    ])
                  ]),
                  
                  // Challenge dropdown
                  React.createElement('div', {}, [
                    React.createElement('label', {
                      htmlFor: 'challenge',
                      className: 'block mb-2 font-medium text-gray-700'
                    }, 'Challenge'),
                    React.createElement('select', {
                      id: 'challenge',
                      value: selectedChallenge,
                      onChange: (e) => setSelectedChallenge(e.target.value),
                      disabled: !selectedTopic,
                      className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all disabled:bg-gray-100 disabled:text-gray-500'
                    }, [
                      React.createElement('option', { value: '' }, 'Select a challenge'),
                      ...getChallenges(selectedTopic).map(challenge => 
                        React.createElement('option', { key: challenge, value: challenge }, challenge)
                      )
                    ])
                  ]),
                  
                  // Project Type dropdown
                  React.createElement('div', {}, [
                    React.createElement('label', {
                      htmlFor: 'projectType',
                      className: 'block mb-2 font-medium text-gray-700'
                    }, 'Project Type'),
                    React.createElement('select', {
                      id: 'projectType',
                      value: selectedProjectType,
                      onChange: (e) => setSelectedProjectType(e.target.value),
                      disabled: !selectedChallenge,
                      className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all disabled:bg-gray-100 disabled:text-gray-500'
                    }, [
                      React.createElement('option', { value: '' }, 'Select a project type'),
                      ...getProjectTypes(selectedTopic, selectedChallenge).map(type => 
                        React.createElement('option', { key: type, value: type }, type)
                      )
                    ])
                  ]),
                  
                  // Description textarea
                  React.createElement('div', {}, [
                    React.createElement('label', {
                      htmlFor: 'description',
                      className: 'block mb-2 font-medium text-gray-700'
                    }, 'Project Description (Optional)'),
                    React.createElement('textarea', {
                      id: 'description',
                      value: description,
                      onChange: (e) => setDescription(e.target.value),
                      placeholder: 'Provide any additional details about your project...',
                      className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all min-h-[120px] resize-y'
                    })
                  ]),
                  
                  // Submit button
                  React.createElement('button', {
                    type: 'submit',
                    disabled: !selectedTopic || !selectedChallenge || !selectedProjectType || isLoading,
                    className: 'btn-apple py-3 px-4 font-medium text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed'
                  }, isLoading ? 'Generating...' : 'Generate Game Plan')
                ]),
              ]),
              
              // AI Question Section - NEW COMPONENT
              aiQuestion && React.createElement('div', {
                className: 'mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg shadow-subtle'
              }, [
                React.createElement('div', {
                  className: 'flex items-start mb-4'
                }, [
                  React.createElement('div', {
                    className: 'w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white mr-3 flex-shrink-0'
                  }, [
                    React.createElement('i', { className: 'fas fa-robot' })
                  ]),
                  React.createElement('div', {}, [
                    React.createElement('h3', {
                      className: 'font-semibold text-gray-800 mb-2'
                    }, 'AI Feedback Assistant'),
                    React.createElement('p', {
                      className: 'text-gray-700'
                    }, aiQuestion)
                  ])
                ]),
                React.createElement('div', {
                  className: 'ml-12 flex flex-col space-y-2'
                }, [
                  React.createElement('textarea', {
                    placeholder: 'Type your answer here...',
                    className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all min-h-[100px] resize-y'
                  }),
                  React.createElement('div', {
                    className: 'flex justify-end'
                  }, [
                    React.createElement('button', {
                      onClick: () => handleAnswerQuestion(document.querySelector('textarea').value),
                      className: 'btn-apple py-2 px-4 flex items-center'
                    }, [
                      React.createElement('i', { className: 'fas fa-paper-plane mr-2' }),
                      'Send Answer'
                    ])
                  ])
                ])
              ]),
              
              // AI Response Notification - NEW COMPONENT
              aiResponse && React.createElement('div', {
                className: 'mb-8 p-4 bg-green-50 border border-green-200 rounded-lg shadow-subtle flex items-center'
              }, [
                React.createElement('i', { className: 'fas fa-check-circle text-green-500 mr-3 text-xl' }),
                React.createElement('p', { className: 'text-green-800' }, aiResponse)
              ]),
              
              // Loading, Error and Results sections remain largely the same
              // ...

              // Generated Game Plan Results
              gamePlanResult && React.createElement('div', { 
                className: 'game-plan-results mt-8 p-6 bg-white border border-gray-200 rounded-lg shadow-card transition-all'
              }, [
                // Existing plan sections remain the same
                // ...
                
                // Updated Revision/Chat Input Section
                React.createElement('div', { className: 'mt-8 pt-6 border-t border-gray-200' }, [
                  React.createElement('h4', { className: 'text-lg font-semibold text-gray-800 mb-3' }, 'Refine Your Plan'),
                  React.createElement('p', { className: 'text-gray-600 mb-4' }, 'Have questions or want to refine your plan? Add your feedback below:'),
                  
                  React.createElement('form', { 
                    onSubmit: handleRevision,
                    className: 'space-y-4'
                  }, [
                    // Textarea for revision input
                    React.createElement('textarea', {
                      value: revisionText,
                      onChange: (e) => setRevisionText(e.target.value),
                      placeholder: 'Examples:\n• "Could you add more details about deployment options?"\n• "Please focus more on beginner-friendly tools."\n• "What are the cost considerations for these recommendations?"',
                      className: 'w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all min-h-[120px] resize-y'
                    }),
                    
                    // Submit revision button
                    React.createElement('button', {
                      type: 'submit',
                      disabled: isRevising || !revisionText.trim(),
                      className: 'btn-apple py-3 px-6 font-medium text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center'
                    }, [
                      React.createElement('i', { className: 'fas fa-sync-alt mr-2' }),
                      isRevising ? 'Refining Plan...' : 'Refine Plan'
                    ])
                  ]),
                  
                  // Enhanced revision history with timestamps
                  revisionHistory.length > 0 && React.createElement('div', { className: 'mt-6' }, [
                    React.createElement('h5', { className: 'text-sm font-medium text-gray-500 mb-2' }, 'Conversation History'),
                    React.createElement('div', { className: 'bg-gray-50 p-3 rounded-lg text-sm text-gray-600 max-h-60 overflow-y-auto' }, 
                      revisionHistory.map((item, index) => 
                        React.createElement('div', { 
                          key: 'history-' + index, 
                          className: 'mb-3 pb-3 border-b border-gray-200 last:border-0 last:mb-0 last:pb-0' 
                        }, [
                          React.createElement('div', { className: 'flex justify-between items-center mb-1' }, [
                            React.createElement('span', { className: 'font-medium' }, 
                              item.revisionPrompt ? 'You asked:' : 'Original plan'
                            ),
                            item.timestamp && React.createElement('span', { className: 'text-xs text-gray-400' },
                              new Date(item.timestamp).toLocaleString()
                            )
                          ]),
                          item.revisionPrompt && React.createElement('p', { className: 'italic' }, `"${item.revisionPrompt}"`)
                        ])
                      )
                    )
                  ])
                ])
              ])
            ]);
          }
          
          // Event handler for the Create New Plan button
          document.getElementById('create-new-plan-btn')?.addEventListener('click', () => {
            // Find the select element and set it to 'new'
            const select = document.getElementById('game-plan-history');
            if (select) {
              select.value = 'new';
              // Trigger the change event
              const event = new Event('change');
              select.dispatchEvent(event);
            }
          });
          
          // Render the app to the DOM
          if (rootElement) {
            // Hide the loading indicator
            const loadingEl = document.getElementById('loading-fallback');
            if (loadingEl) loadingEl.style.display = 'none';
            
            // Render our component
            ReactDOM.render(
              React.createElement(GamePlanApp, null),
              rootElement
            );
            
            console.log('Game Plan component rendered successfully!');
          } else {
            console.error('Root element not found!');
          }
      }
      
      // NOTE: We no longer immediately invoke the script or use DOMContentLoaded.
      // Rendering is now triggered by the onAuthStateChanged callback.
    </script>

    <!-- Sample challenges based on topic - updated with business-focused challenges -->
    <script>
      const getChallenges = (topic) => {
        if (!topic) return [];
        
        switch(topic) {
          case 'eCommerce':
            return [
              'Sales Funnel Optimization',
              'Product Selection & Sourcing',
              'Payment Processing & Checkout',
              'Customer Retention & Loyalty',
              'Inventory Management',
              'Marketing Automation',
              'Order Fulfillment',
              'Abandoned Cart Recovery'
            ];
          case 'Introduction to AI':
            return [
              'Customer Service Automation',
              'Content Generation',
              'Data Analysis & Insights',
              'Personalization Engines',
              'Predictive Forecasting'
            ];
          case 'Office Productivity':
            return [
              'Document Automation',
              'Meeting Optimization',
              'Email Management',
              'Process Streamlining',
              'Team Collaboration'
            ];
          case 'Personal Finance':
            return [
              'Budgeting & Expense Tracking',
              'Investment Planning',
              'Debt Management',
              'Retirement Planning',
              'Tax Optimization'
            ];
          case 'Social Media Marketing':
            return [
              'Content Calendar Automation',
              'Audience Growth Strategies',
              'Engagement Optimization',
              'Ad Campaign Management',
              'Performance Analytics'
            ];
          case 'Videography':
            return [
              'Video Editing Workflow',
              'Content Distribution',
              'Audience Growth',
              'Monetization Strategies',
              'Equipment Selection'
            ];
          default:
            return [
              'Workflow Automation',
              'Customer Engagement',
              'Revenue Optimization',
              'Cost Reduction',
              'Data Analysis'
            ];
        }
      };

      // Sample project types based on business goals
      const getProjectTypes = (topic, challenge) => {
        if (!topic || !challenge) return [];
        
        return [
          'Personal Project', 
          'Small Business', 
          'Enterprise Solution'
        ];
      };
    </script>
</body>
</html>
