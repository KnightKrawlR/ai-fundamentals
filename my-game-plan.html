<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Game Plan | AI Fundamentals</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/game-styles.css">
    <link rel="stylesheet" href="css/header-redesign.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add SF Pro font for Apple-like aesthetic -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    
    <!-- Add Tailwind CSS for the React app -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Mermaid JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      // Initialize Mermaid
      mermaid.initialize({ 
        startOnLoad: false, // We will render manually
        securityLevel: 'loose', // Required for some diagram features
        theme: 'default',
        flowchart: {
          htmlLabels: true,
          curve: 'linear',
          diagramPadding: 8
        },
        logLevel: 3 // Error level logging only
      });
      
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                200: '#bae6fd',
                300: '#7dd3fc',
                400: '#38bdf8',
                500: '#0ea5e9',
                600: '#0284c7',
                700: '#0369a1',
                800: '#075985',
                900: '#0c4a6e',
              },
            },
          },
        },
      }
    </script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>

    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>

    <style>
      /* Override styles for React components */
      #my-game-plan-root {
        min-height: 500px;
        padding: 20px 0;
      }
      
      /* Improved styles for Apple-like aesthetic */
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        color: #1a1a1a;
      }
      
      /* Fix for primary color classes */
      .bg-primary-500 {
        background-color: #0ea5e9;
      }
      .bg-primary-600 {
        background-color: #0284c7;
      }
      .bg-primary-700 {
        background-color: #0369a1;
      }
      .text-primary-600 {
        color: #0284c7;
      }
      .border-primary-500 {
        border-color: #0ea5e9;
      }
      .bg-primary-100 {
        background-color: #e0f2fe;
      }
      .bg-primary-50 {
        background-color: #f0f9ff;
      }
      
      /* Apple-like subtle transitions */
      .transition-all {
        transition: all 0.2s ease-in-out;
      }
      
      .shadow-subtle {
        box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.02);
      }
      
      .shadow-card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      }
      
      /* Apple-style button */
      .btn-apple {
        background-color: #0a84ff;
        color: white;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      
      .btn-apple:hover:not(:disabled) {
        background-color: #0060df;
        transform: translateY(-1px);
      }
      
      .btn-apple:active:not(:disabled) {
        transform: translateY(0);
      }
      
      .btn-apple:disabled {
        background-color: #b3d1ff;
        cursor: not-allowed;
      }
      
      /* Basic utility classes that might be missing */
      .flex { display: flex; }
      .flex-1 { flex: 1; }
      .flex-col { flex-direction: column; }
      .items-center { align-items: center; }
      .justify-center { justify-content: center; }
      .space-y-4 > * + * { margin-top: 1rem; }
      .min-h-\[500px\] { min-height: 500px; }
      .rounded-lg { border-radius: 0.5rem; }
      .rounded-md { border-radius: 0.375rem; }
      .rounded { border-radius: 0.25rem; }
      .p-4 { padding: 1rem; }
      .border { border-width: 1px; }
      
      /* Mermaid Diagram Styles */
      .mermaid-diagram-container {
        overflow-x: auto;
        margin: 20px 0;
      }
      
      .mermaid-diagram-render {
        display: flex;
        justify-content: center;
        margin: 0 auto;
        text-align: center;
      }
      
      /* Override Mermaid SVG styles for better visibility */
      .mermaid svg {
        max-width: 100%;
        height: auto !important;
        margin: 0 auto;
      }
      
      /* Style Mermaid diagram nodes and text */
      .mermaid .node rect, 
      .mermaid .node circle, 
      .mermaid .node ellipse, 
      .mermaid .node polygon {
        fill: #e0f2fe !important;
        stroke: #0284c7 !important;
      }
      
      .mermaid .edgePath .path {
        stroke: #64748b !important;
        stroke-width: 2px !important;
      }
      
      .mermaid .flowchart-link {
        stroke: #64748b !important;
        stroke-width: 2px !important;
      }
      
      .mermaid .label {
        color: #334155 !important;
      }

      /* User menu styles */
      .user-menu {
          position: relative;
          display: inline-block;
      }

      .user-menu-content {
          display: none;
          position: absolute;
          right: 0;
          background-color: white;
          min-width: 200px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          border-radius: 4px;
          padding: 8px 0;
          z-index: 1000;
      }

      .user-menu:hover .user-menu-content {
          display: block;
      }

      .user-menu-item {
          display: block;
          padding: 8px 16px;
          color: #333;
          text-decoration: none;
          transition: background-color 0.3s;
      }

      .user-menu-item:hover {
          background-color: #f5f5f5;
      }

      .user-menu-divider {
          height: 1px;
          background-color: #eee;
          margin: 8px 0;
      }

      .user-profile-btn {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 16px;
          border: none;
          background: none;
          cursor: pointer;
          color: white;
      }

      .user-avatar {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          background-color: #6c5ce7;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 500;
      }

      .sign-in-btn {
          display: flex;
          align-items: center;
          gap: 8px;
          color: white;
          background: none;
          border: none;
          cursor: pointer;
          font-size: 1rem;
          text-decoration: none;
      }

      .sign-in-btn i {
          font-size: 20px;
      }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <a href="/" class="logo">
                <i class="fas fa-brain"></i>
                <h1>AI Fundamentals</h1>
            </a>
            <nav>
                <ul>
                    <li><a href="/learning.html">Learning</a></li>
                    <li><a href="/ai-tools.html">AI Tools</a></li>
                    <li><a href="/premium.html">Premium</a></li>
                </ul>
            </nav>
            <div id="auth-container">
                <a href="login.html" class="sign-in-btn" id="sign-in-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Sign In</span>
                </a>
                <div class="user-menu" id="user-menu" style="display: none;">
                    <button class="user-profile-btn">
                        <div class="user-avatar" id="user-avatar"></div>
                        <span id="user-email"></span>
                    </button>
                    <div class="user-menu-content">
                        <a href="/account.html" class="user-menu-item">
                            <i class="fas fa-user"></i> My Account
                        </a>
                        <a href="/my-learning.html" class="user-menu-item">
                            <i class="fas fa-graduation-cap"></i> My Learning
                        </a>
                        <a href="/my-games.html" class="user-menu-item premium-item">
                            <i class="fas fa-gamepad"></i> My Games
                        </a>
                        <a href="/my-game-plan.html" class="user-menu-item premium-item">
                            <i class="fas fa-clipboard-list"></i> My Game Plan
                        </a>
                        <a href="/settings.html" class="user-menu-item">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <div class="user-menu-divider"></div>
                        <a href="#" class="user-menu-item" id="sign-out-btn">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            <div class="page-header mb-6"> 
                <h1 class="text-3xl font-bold mb-2">Create New Game Plan</h1>
                <p class="text-gray-600">Select your topic, challenge, and project type, then describe your goal to generate a personalized AI implementation plan.</p> 
            </div>
            
            <div id="my-game-plan-root"></div>
            
            <!-- Fallback if React fails to load -->
            <div id="loading-fallback" style="display: flex; justify-content: center; align-items: center; height: 300px;">
                    <div style="text-align: center;">
                        <div class="spinner" style="border: 4px solid rgba(0,0,0,.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #5D3FD3; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        <p style="margin-top: 16px;">Loading Game Plan generator...</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>AI Fundamentals</h3>
                    <p>Your journey to AI mastery starts here</p>
                </div>
                <div class="footer-section">
                    <h3>Resources</h3>
                    <ul>
                        <li><a href="#">Flashcards</a></li>
                        <li><a href="#">Study Guides</a></li>
                        <li><a href="#">Video Lessons</a></li>
                        <li><a href="#">Practice Quizzes</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Company</h3>
                    <ul>
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Contact</a></li>
                        <li><a href="#">Careers</a></li>
                        <li><a href="#">Blog</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Legal</h3>
                    <ul>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Cookie Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 AI Fundamentals. All rights reserved.</p>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <!-- Auth Integration -->
    <script src="js/auth-integration.js"></script>
    <script src="js/stripe-integration.js"></script>
    <script src="js/access-control.js"></script>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjMisQkMgdA6qNg7gnXDumhNOOWOD-Y00",
            authDomain: "ai-fundamentals-ad37d.firebaseapp.com",
            projectId: "ai-fundamentals-ad37d",
            storageBucket: "ai-fundamentals-ad37d.appspot.com",
            messagingSenderId: "668115447112",
            appId: "1:668115447112:web:c0772e9f8c6a498737977d",
            measurementId: "G-2D5V39EQ3T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Auth state observer
        firebase.auth().onAuthStateChanged((user) => {
            const signInBtn = document.getElementById('sign-in-btn');
            const userMenu = document.getElementById('user-menu');
            const userAvatar = document.getElementById('user-avatar');
            const userEmail = document.getElementById('user-email');
            
            if (user) {
                // User is signed in
                console.log('User authenticated, proceeding to render Game Plan');
                signInBtn.style.display = 'none';
                userMenu.style.display = 'block';
                
                // Set user email and avatar
                userEmail.textContent = user.email;
                userAvatar.textContent = user.email[0].toUpperCase();
                
                // Update premium content visibility
                document.querySelectorAll('.premium-content').forEach(elem => {
                    elem.classList.add('unlocked');
                });
                
                // --- Render the React component ONLY if user is logged in ---
                renderGamePlanComponent(); 
                // ---------
            } else {
                // User is signed out
                console.log('User not authenticated, redirecting to login');
                signInBtn.style.display = 'flex';
                userMenu.style.display = 'none';
                
                // Update premium content visibility
                document.querySelectorAll('.premium-content').forEach(elem => {
                    elem.classList.remove('unlocked');
                });
                
                // Redirect to login page since this is a premium feature
                window.location.href = 'login.html?redirect=my-game-plan.html';
            }
        });

        // Sign out functionality
        document.getElementById('sign-out-btn').addEventListener('click', (e) => {
            e.preventDefault();
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Sign out error:', error);
            });
        });
        
        // Initialize user credits if needed
        function initializeUserCreditsIfNeeded(userId) {
            const db = firebase.firestore();
            
            // First check if user document exists
            db.collection('users').doc(userId).get().then((doc) => {
                if (!doc.exists) {
                    // Create the user document first with initial data
                    return db.collection('users').doc(userId).set({
                        credits: 10, // Initial credits for new users
                    });
                }
            }).catch((error) => {
                console.error('Error checking/initializing user credits:', error);
            });
        }
    </script>

    <!-- Make Firebase available to the React app -->
    <script>
        // Make Firebase accessible to the React component
        window.firebase = firebase;
        
        // Add debugging info
        console.log('Firebase initialized:', typeof firebase !== 'undefined');
        console.log('React available:', typeof React !== 'undefined');
        console.log('ReactDOM available:', typeof ReactDOM !== 'undefined');
        
        // Clear any inline React components to avoid conflicts
        window.addEventListener('DOMContentLoaded', function() {
          try {
            const rootElement = document.getElementById('my-game-plan-root');
            if (rootElement) {
              // Remove any existing content to ensure a clean mount
              rootElement.innerHTML = '';
            }
          } catch (error) {
            console.error('Error clearing root element:', error);
          }
        });
    </script>

    <!-- Game Plan Component - Inline Script -->
    <script>
      // Function to render the Game Plan component
      function renderGamePlanComponent() {
          console.log("Attempting to render Game Plan component...");
      
          // Verify React and ReactDOM are available
          if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
            console.error('React or ReactDOM is not available!');
            return;
          }
          
          // Check if component already rendered (prevent double render)
          const rootElement = document.getElementById('my-game-plan-root');
          if (rootElement && rootElement.hasChildNodes()) {
              console.log("Game Plan component already rendered.");
              return;
          }

          // Simple Game Plan Component with three dropdowns
          function GamePlanApp() {
            // State hooks for form inputs
            const [selectedTopic, setSelectedTopic] = React.useState('');
            const [selectedChallenge, setSelectedChallenge] = React.useState('');
            const [selectedProjectType, setSelectedProjectType] = React.useState('');
            const [description, setDescription] = React.useState('');
            
            // State for API interaction
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [gamePlanResult, setGamePlanResult] = React.useState(null);
            
            // New state for revision functionality
            const [revisionText, setRevisionText] = React.useState('');
            const [isRevising, setIsRevising] = React.useState(false);
            const [revisionHistory, setRevisionHistory] = React.useState([]);
            
            // State for form collapse (starts open)
            const [isFormCollapsed, setIsFormCollapsed] = React.useState(false);

            // State for collapsible sections (true = open)
            const [sectionsOpen, setSectionsOpen] = React.useState({});

            React.useEffect(() => {
              // Reset open states AND initialize Mermaid when a new game plan is generated
              let initialStates = {};
              const sectionKeys = ['milestones', 'steps', 'technologies', 'resources', 'roadblocks', 'metrics', 'diagram'];
              
              if (gamePlanResult) {
                  // Start all sections expanded, with special emphasis on the diagram section
                  sectionKeys.forEach(key => { initialStates[key] = true; });
                  setIsFormCollapsed(true); // Collapse form when results appear
              } else {
                  setIsFormCollapsed(false); // Ensure form is open if no results
                  // No result sections to set state for, initialStates remains {}
              }
              setSectionsOpen(initialStates);
              
              // Initialize Mermaid rendering after results are potentially set
              if (gamePlanResult && gamePlanResult.mermaid_diagram) {
                // Delay slightly to ensure DOM update before Mermaid runs
                setTimeout(() => {
                    try {
                        console.log('Initializing Mermaid for diagram...');
                        // Clear any previous renderings
                        document.querySelectorAll('.mermaid-diagram-render').forEach(el => {
                            // Store the diagram text for later use
                            const diagramText = el.textContent;
                            // Clear element for fresh rendering
                            el.textContent = diagramText;
                        });
                        
                        // Run mermaid to render all diagram elements
                        mermaid.run({ 
                            nodes: document.querySelectorAll('.mermaid-diagram-render'),
                            suppressErrors: false
                        });
                    } catch (err) {
                        console.error('Mermaid rendering error:', err);
                    }
                }, 300); // Increase timeout to ensure DOM is ready
              }
            }, [gamePlanResult]);

            // Function to toggle section visibility
            const toggleSection = (sectionKey) => {
                setSectionsOpen(prev => ({ ...prev, [sectionKey]: !prev[sectionKey] }));
            };
            
            // --- Helper function INSIDE GamePlanApp scope ---
            function renderCollapsibleSection(sectionKey, title, dataArray, renderItem, listType = 'ul', listClassName = 'list-none space-y-3') {
                if (!dataArray || dataArray.length === 0) return null;
                
                const isOpen = sectionsOpen[sectionKey]; // Now has access to sectionsOpen

                return React.createElement('div', { className: 'mb-4 border-b border-gray-200 pb-4 last:border-b-0' }, [
                    React.createElement('button', { 
                        className: 'w-full text-left text-xl font-semibold text-gray-800 mb-2 flex justify-between items-center focus:outline-none hover:text-blue-600 transition-colors', 
                        onClick: () => toggleSection(sectionKey) // Now has access to toggleSection
                    }, [
                      title,
                      React.createElement('i', { 
                          className: `fas fa-chevron-down transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}` 
                      })
                    ]),
                    // Conditionally render the content wrapper and items
                    isOpen && React.createElement(listType, { className: listClassName + ' mt-2 pl-2 pr-2' }, 
                        dataArray.map(renderItem)
                    )
                ]);
            }
            // --- End of helper function definition ---
            
            // Sample topics
            const topics = [
              'Introduction to AI',
              'Office Productivity',
              'Personal Finance',
              'Social Media Marketing',
              'Videography',
              'eCommerce'
            ];
            
            // Sample challenges based on topic
            const getChallenges = (topic) => {
              if (!topic) return [];
              
              switch(topic) {
                case 'Introduction to AI':
                  return ['Understanding AI Concepts', 'Machine Learning', 'Natural Language Processing'];
                case 'Office Productivity':
                  return ['Document Automation', 'Email Management', 'Meeting Optimization'];
                case 'Personal Finance':
                  return ['Budgeting', 'Investment Planning', 'Debt Management'];
                default:
                  return ['Challenge 1', 'Challenge 2', 'Challenge 3'];
              }
            };
            
            // Sample project types
            const getProjectTypes = (topic, challenge) => {
              if (!topic || !challenge) return [];
              return ['Personal Project', 'Small Business', 'Enterprise Solution'];
            };
            
            // Reset dependent dropdowns when topic changes
            React.useEffect(() => {
              setSelectedChallenge('');
              setSelectedProjectType('');
            }, [selectedTopic]);
            
            // Reset project type when challenge changes
            React.useEffect(() => {
              setSelectedProjectType('');
            }, [selectedChallenge]);
            
            // Handle form submission - Update to store original plan in history
            const handleSubmit = async (e) => {
              e.preventDefault();
              setIsLoading(true);
              setError(null);
              
              // Store previous plan in history if it exists
              if (gamePlanResult) {
                setRevisionHistory(prev => [...prev, {
                  plan: gamePlanResult,
                  revisionPrompt: null // No revision prompt for initial plan
                }]);
              }
              
              setGamePlanResult(null);
              
              // Construct the data object to send to the function
              const requestData = {
                topic: selectedTopic,
                challenge: selectedChallenge,
                projectType: selectedProjectType,
                projectDescription: description || ''
              };
              
              console.log("Calling generateGamePlan with data:", requestData);
              
              try {
                // Ensure Firebase functions is available
                if (!window.firebase || !window.firebase.functions) {
                    throw new Error("Firebase Functions SDK is not available.");
                }
                
                // Ensure we are calling the function that uses Grok API
                const actualGamePlanFunction = firebase.functions().httpsCallable('generateGamePlan');
                const result = await actualGamePlanFunction(requestData);
                
                console.log("Received response from generateGamePlan function:", result);
                
                if (result.data && typeof result.data === 'object') {
                  setGamePlanResult(result.data);
                } else {
                  throw new Error(result.data?.error || result.data || 'Invalid response structure from function.');
                }
              } catch (err) {
                console.error("Error calling generateGamePlan:", err);
                setError(err.message || 'Failed to generate game plan. Please try again.');
              } finally {
                setIsLoading(false);
              }
            };
            
            // Handle revision submission
            const handleRevision = async (e) => {
              e.preventDefault();
              if (!revisionText.trim()) return;
              
              setIsRevising(true);
              setError(null);
              
              // Store current plan in history
              setRevisionHistory(prev => [...prev, {
                plan: gamePlanResult,
                revisionPrompt: revisionText
              }]);
              
              // Construct the data object with revision info
              const requestData = {
                topic: selectedTopic,
                challenge: selectedChallenge,
                projectType: selectedProjectType,
                projectDescription: description || '',
                previousPlan: JSON.stringify(gamePlanResult),
                revisionRequest: revisionText
              };
              
              console.log("Calling generateGamePlan with revision:", requestData);
              
              try {
                // Ensure Firebase functions is available
                if (!window.firebase || !window.firebase.functions) {
                    throw new Error("Firebase Functions SDK is not available.");
                }
                
                // Call the same function but with revision data
                const actualGamePlanFunction = firebase.functions().httpsCallable('generateGamePlan');
                const result = await actualGamePlanFunction(requestData);
                
                console.log("Received revised plan:", result);
                
                if (result.data && typeof result.data === 'object') {
                  setGamePlanResult(result.data);
                  setRevisionText(''); // Clear the revision input
                } else {
                  throw new Error(result.data?.error || result.data || 'Invalid response structure from function.');
                }
              } catch (err) {
                console.error("Error calling revision:", err);
                setError(err.message || 'Failed to revise game plan. Please try again.');
              } finally {
                setIsRevising(false);
              }
            };
            
            // Render the form and results
            return React.createElement('div', {
              className: 'max-w-4xl mx-auto p-5 font-sans' // Wider container with Apple-like font
            }, [
              // -- Input Form Section (Now Collapsible) --
              React.createElement('div', { 
                className: 'mb-8 p-6 bg-white border border-gray-200 rounded-lg shadow-card transition-all' 
              }, [
                  React.createElement('button', { 
                      className: 'w-full text-left text-2xl font-semibold text-gray-800 mb-4 flex justify-between items-center focus:outline-none hover:text-blue-600 transition-colors', 
                      onClick: () => setIsFormCollapsed(!isFormCollapsed)
                  }, [
                      'Create New Game Plan', // Title for the collapsible form section
                      React.createElement('i', { 
                          className: `fas fa-chevron-down transition-transform duration-200 ${isFormCollapsed ? '' : 'rotate-180'}` 
                      })
                  ]),
                  // Conditionally render the form based on collapse state
                  !isFormCollapsed && React.createElement('form', {
                      onSubmit: handleSubmit,
                      className: 'flex flex-col space-y-5'
                  }, [
                    // Topic dropdown
                    React.createElement('div', {}, [
                      React.createElement('label', {
                        htmlFor: 'topic',
                        className: 'block mb-2 font-medium text-gray-700'
                      }, 'Topic'),
                      React.createElement('select', {
                        id: 'topic',
                        value: selectedTopic,
                        onChange: (e) => setSelectedTopic(e.target.value),
                        className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all'
                      }, [
                        React.createElement('option', { value: '' }, 'Select a topic'),
                        ...topics.map(topic => 
                          React.createElement('option', { key: topic, value: topic }, topic)
                        )
                      ])
                    ]),
                    
                    // Challenge dropdown
                    React.createElement('div', {}, [
                      React.createElement('label', {
                        htmlFor: 'challenge',
                        className: 'block mb-2 font-medium text-gray-700'
                      }, 'Challenge'),
                      React.createElement('select', {
                        id: 'challenge',
                        value: selectedChallenge,
                        onChange: (e) => setSelectedChallenge(e.target.value),
                        disabled: !selectedTopic,
                        className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all disabled:bg-gray-100 disabled:text-gray-500'
                      }, [
                        React.createElement('option', { value: '' }, 'Select a challenge'),
                        ...getChallenges(selectedTopic).map(challenge => 
                          React.createElement('option', { key: challenge, value: challenge }, challenge)
                        )
                      ])
                    ]),
                    
                    // Project Type dropdown
                    React.createElement('div', {}, [
                      React.createElement('label', {
                        htmlFor: 'projectType',
                        className: 'block mb-2 font-medium text-gray-700'
                      }, 'Project Type'),
                      React.createElement('select', {
                        id: 'projectType',
                        value: selectedProjectType,
                        onChange: (e) => setSelectedProjectType(e.target.value),
                        disabled: !selectedChallenge,
                        className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all disabled:bg-gray-100 disabled:text-gray-500'
                      }, [
                        React.createElement('option', { value: '' }, 'Select a project type'),
                        ...getProjectTypes(selectedTopic, selectedChallenge).map(type => 
                          React.createElement('option', { key: type, value: type }, type)
                        )
                      ])
                    ]),
                    
                    // Description textarea
                    React.createElement('div', {}, [
                      React.createElement('label', {
                        htmlFor: 'description',
                        className: 'block mb-2 font-medium text-gray-700'
                      }, 'Project Description (Optional)'),
                      React.createElement('textarea', {
                        id: 'description',
                        value: description,
                        onChange: (e) => setDescription(e.target.value),
                        placeholder: 'Provide any additional details about your project...',
                        className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all min-h-[120px] resize-y'
                      })
                    ]),
                    
                    // Submit button
                    React.createElement('button', {
                      type: 'submit',
                      disabled: !selectedTopic || !selectedChallenge || !selectedProjectType || isLoading,
                      className: 'btn-apple py-3 px-4 font-medium text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed'
                    }, isLoading ? 'Generating...' : 'Generate Game Plan')
                  ]),
              ]),
              
              // --- Display Loading State --- 
              isLoading && React.createElement('div', { 
                className: 'mt-8 text-center p-6 border border-gray-100 rounded-lg shadow-subtle bg-white'
              }, [
                React.createElement('div', { 
                  className: 'spinner mx-auto mb-4', 
                  style: { 
                    border: '4px solid rgba(0,0,0,.1)', 
                    width: '40px', 
                    height: '40px', 
                    borderRadius: '50%', 
                    borderLeftColor: '#0a84ff', 
                    animation: 'spin 1s linear infinite'
                  } 
                }),
                React.createElement('p', { className: 'text-gray-600' }, 'Generating your game plan with AI...')
              ]),
              
              // --- Display Revising State --- 
              isRevising && React.createElement('div', { 
                className: 'mt-8 text-center p-6 border border-gray-100 rounded-lg shadow-subtle bg-white'
              }, [
                React.createElement('div', { 
                  className: 'spinner mx-auto mb-4', 
                  style: { 
                    border: '4px solid rgba(0,0,0,.1)', 
                    width: '40px', 
                    height: '40px', 
                    borderRadius: '50%', 
                    borderLeftColor: '#0a84ff', 
                    animation: 'spin 1s linear infinite'
                  } 
                }),
                React.createElement('p', { className: 'text-gray-600' }, 'Revising your game plan based on feedback...')
              ]),
              
              // --- Display Error State --- 
              error && React.createElement('div', { 
                className: 'mt-8 p-4 bg-red-50 text-red-700 border border-red-100 rounded-lg'
              }, [
                React.createElement('div', { className: 'flex items-center mb-2' }, [
                  React.createElement('i', { className: 'fas fa-exclamation-circle mr-2' }),
                  React.createElement('strong', null, 'Error')
                ]),
                React.createElement('p', null, error)
              ]),
              
              // --- Display Generated Game Plan (Collapsible Sections with Buttons) --- 
              gamePlanResult && React.createElement('div', { 
                  className: 'game-plan-results mt-8 p-6 bg-white border border-gray-200 rounded-lg shadow-card transition-all'
              }, [
                  // Project Summary (Always Visible)
                  gamePlanResult.project_summary && React.createElement('div', { className: 'mb-6 border-b border-gray-200 pb-4' }, [
                      React.createElement('h3', { className: 'text-xl font-semibold text-gray-800 mb-2' }, 'Project Summary'),
                      React.createElement('p', { className: 'text-gray-700' }, gamePlanResult.project_summary)
                  ]),
                  
                  // --- Collapsible Sections --- 
                  
                  renderCollapsibleSection(
                      'diagram', // Unique key for this section
                      'Architecture/Flow Diagram',
                      gamePlanResult.mermaid_diagram ? [gamePlanResult.mermaid_diagram] : [], // Pass diagram string in array
                      (diagramString) => React.createElement('div', { 
                          key: 'mermaid-diag',
                          className: 'mermaid-diagram-container p-4 border rounded-md bg-white'
                      }, [
                          React.createElement('pre', {
                              className: 'mermaid mermaid-diagram-render',
                              style: { textAlign: 'center' }
                          }, diagramString)
                      ]), 
                      'div', // Use div as container instead of ul/ol
                      '' // No extra list class needed
                  ),

                  renderCollapsibleSection(
                      'milestones', 'Key Milestones', gamePlanResult.key_milestones,
                      (item, index) => React.createElement('li', { key: 'milestone-' + index, className: 'flex items-start mb-3' }, [
                          React.createElement('span', { className: 'flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold mr-3 mt-1' }, index + 1),
                          React.createElement('div', null, [
                              React.createElement('strong', { className: 'block text-gray-900' }, item.milestone),
                              React.createElement('p', { className: 'text-gray-600 text-sm' }, item.description)
                          ])
                      ]),
                      'ul', 'list-none space-y-2 pl-1'
                  ),

                  renderCollapsibleSection(
                      'steps', 'Suggested Steps',
                      gamePlanResult.suggested_steps,
                      (item, index) => React.createElement('li', { key: 'step-' + index, className: 'mb-3' }, [
                          React.createElement('strong', { className: 'text-gray-900' }, `${index + 1}. ${item.step}`),
                          item.details && React.createElement('p', { className: 'pl-5 text-sm text-gray-600 mt-1' }, item.details)
                      ]), 
                      'ol', 'list-none space-y-1 pl-1'
                  ),
                  
                  renderCollapsibleSection(
                      'technologies', 'Recommended Technologies',
                      gamePlanResult.recommended_technologies,
                      (item, index) => React.createElement('div', { key: 'tech-' + index, className: 'p-4 border rounded-md bg-white shadow-sm' }, [
                          React.createElement('strong', { className: 'block text-gray-900 text-lg' }, item.name, 
                              item.type && React.createElement('span', { 
                                  className: `ml-2 text-xs font-medium px-2 py-0.5 rounded ${item.type === 'Core' ? 'bg-green-100 text-green-800' : item.type === 'Supporting' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}` 
                              }, item.type)
                          ),
                          item.reasoning && React.createElement('p', { className: 'text-gray-600 text-sm mt-1' }, item.reasoning)
                      ]),
                      'div', 'grid grid-cols-1 md:grid-cols-2 gap-3'
                  ),

                  renderCollapsibleSection(
                      'resources', 'Learning Resources',
                      gamePlanResult.learning_resources,
                      (item, index) => React.createElement('li', { key: 'resource-' + index, className: 'p-3 border rounded-md bg-white flex items-start mb-3 shadow-sm' }, [
                          React.createElement('i', { className: 'fas fa-link text-gray-400 mr-3 mt-1 flex-shrink-0' }),
                          React.createElement('div', null, [
                              React.createElement('a', { href: item.url, target: '_blank', rel: 'noopener noreferrer', className: 'text-blue-600 hover:underline font-medium' }, item.title),
                              item.type && React.createElement('span', { className: 'ml-2 text-xs text-gray-500' }, `(${item.type})`),
                              item.relevance && React.createElement('p', { className: 'text-gray-600 text-sm mt-1' }, item.relevance)
                          ])
                      ]),
                      'ul', 'list-none space-y-0'
                  ),
                  
                  renderCollapsibleSection(
                      'roadblocks', 'Potential Roadblocks',
                      gamePlanResult.potential_roadblocks,
                      (item, index) => React.createElement('li', { key: 'roadblock-' + index, className: 'flex items-start mb-3' }, [
                          React.createElement('i', { className: 'fas fa-exclamation-triangle text-yellow-500 mr-3 mt-1 flex-shrink-0' }), 
                          React.createElement('div', null, [
                              React.createElement('strong', { className: 'block text-gray-900' }, item.roadblock),
                              item.mitigation && React.createElement('p', { className: 'text-gray-600 text-sm' }, 'Mitigation: ' + item.mitigation)
                          ])
                      ]),
                      'ul', 'list-none space-y-2 pl-1'
                  ),

                  renderCollapsibleSection(
                      'metrics', 'Success Metrics',
                      gamePlanResult.success_metrics,
                      (item, index) => React.createElement('li', { key: 'metric-' + index, className: 'flex items-start mb-3' }, [
                          React.createElement('i', { className: 'fas fa-check-circle text-green-500 mr-3 mt-1 flex-shrink-0' }),
                          React.createElement('div', null, [
                              React.createElement('strong', { className: 'block text-gray-900' }, item.metric),
                              item.measurement && React.createElement('p', { className: 'text-gray-600 text-sm' }, 'Measurement: ' + item.measurement)
                          ])
                      ]),
                      'ul', 'list-none space-y-2 pl-1'
                  ),
                  
                  // Next Steps Prompt (Always Visible)
                  gamePlanResult.next_steps_prompt && React.createElement('div', { className: 'mt-6 pt-4 border-t border-gray-200' }, [
                      React.createElement('h4', { className: 'text-lg font-semibold text-gray-800 mb-1' }, 'Next Steps'),
                      React.createElement('p', { className: 'text-gray-700' }, gamePlanResult.next_steps_prompt)
                  ]),
                  
                  // NEW: Revision/Chat Input Section
                  React.createElement('div', { className: 'mt-8 pt-6 border-t border-gray-200' }, [
                      React.createElement('h4', { className: 'text-lg font-semibold text-gray-800 mb-3' }, 'Refine Your Plan'),
                      React.createElement('p', { className: 'text-gray-600 mb-4' }, 'Have questions or want to refine your plan? Add your feedback below:'),
                      
                      React.createElement('form', { 
                          onSubmit: handleRevision,
                          className: 'space-y-4'
                      }, [
                          // Textarea for revision input
                          React.createElement('textarea', {
                              value: revisionText,
                              onChange: (e) => setRevisionText(e.target.value),
                              placeholder: 'Example: "Could you add more details about deployment options?" or "Please focus more on machine learning techniques."',
                              className: 'w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all min-h-[120px] resize-y'
                          }),
                          
                          // Submit revision button
                          React.createElement('button', {
                              type: 'submit',
                              disabled: isRevising || !revisionText.trim(),
                              className: 'btn-apple py-3 px-6 font-medium text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center'
                          }, [
                              React.createElement('i', { className: 'fas fa-sync-alt mr-2' }),
                              isRevising ? 'Revising...' : 'Revise Plan'
                          ])
                      ]),
                      
                      // Show revision history if it exists
                      revisionHistory.length > 0 && React.createElement('div', { className: 'mt-6' }, [
                          React.createElement('h5', { className: 'text-sm font-medium text-gray-500 mb-2' }, 'Revision History'),
                          React.createElement('div', { className: 'bg-gray-50 p-3 rounded-lg text-sm text-gray-600 max-h-40 overflow-y-auto' }, 
                              revisionHistory.map((item, index) => 
                                  React.createElement('div', { key: 'history-' + index, className: 'mb-2 pb-2 border-b border-gray-200 last:border-0' }, 
                                      item.revisionPrompt 
                                          ? `Revision ${index + 1}: "${item.revisionPrompt}"` 
                                          : 'Original plan'
                                  )
                              )
                          )
                      ])
                  ])
              ])
            ]);
          }
          
          // Render the app to the DOM
          if (rootElement) {
            // Hide the loading indicator
            const loadingEl = document.getElementById('loading-fallback');
            if (loadingEl) loadingEl.style.display = 'none';
            
            // Render our component
            ReactDOM.render(
              React.createElement(GamePlanApp, null),
              rootElement
            );
            
            console.log('Game Plan component rendered successfully!');
          } else {
            console.error('Root element #my-game-plan-root not found!');
          }
      }
      
      // NOTE: We no longer immediately invoke the script or use DOMContentLoaded.
      // Rendering is now triggered by the onAuthStateChanged callback.
    </script>
</body>
</html>
