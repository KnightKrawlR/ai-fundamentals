<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Game Plan | AI Fundamentals</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/game-styles.css">
    <link rel="stylesheet" href="css/header-redesign.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add SF Pro font for Apple-like aesthetic -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    
    <!-- Add Tailwind CSS for the React app -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Mermaid JS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script>
      // Initialize mermaid with robust configuration
      if (typeof mermaid !== 'undefined') {
        mermaid.initialize({
          startOnLoad: false,
          securityLevel: 'loose',
          theme: 'default',
          logLevel: 'error',
          flowchart: { 
            htmlLabels: true,
            useMaxWidth: true,
            curve: 'basis'
          },
          sequence: { 
            useMaxWidth: true
          },
          gantt: {
            useMaxWidth: true
          },
          er: {
            useMaxWidth: true
          }
        });
        console.log('Mermaid initialized successfully');
      } else {
        console.error('Mermaid library not loaded');
      }
    </script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>

    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>

    <style>
      /* Override styles for React components */
      #my-game-plan-root {
        min-height: 500px;
        padding: 20px 0;
      }
      
      /* Improved styles for Apple-like aesthetic */
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        color: #1a1a1a;
      }
      
      /* Fix for primary color classes */
      .bg-primary-500 {
        background-color: #0ea5e9;
      }
      .bg-primary-600 {
        background-color: #0284c7;
      }
      .bg-primary-700 {
        background-color: #0369a1;
      }
      .text-primary-600 {
        color: #0284c7;
      }
      .border-primary-500 {
        border-color: #0ea5e9;
      }
      .bg-primary-100 {
        background-color: #e0f2fe;
      }
      .bg-primary-50 {
        background-color: #f0f9ff;
      }
      
      /* Apple-like subtle transitions */
      .transition-all {
        transition: all 0.2s ease-in-out;
      }
      
      .shadow-subtle {
        box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.02);
      }
      
      .shadow-card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      }
      
      /* Apple-style button */
      .btn-apple {
        background-color: #0a84ff;
        color: white;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      
      .btn-apple:hover:not(:disabled) {
        background-color: #0060df;
        transform: translateY(-1px);
      }
      
      .btn-apple:active:not(:disabled) {
        transform: translateY(0);
      }
      
      .btn-apple:disabled {
        background-color: #b3d1ff;
        cursor: not-allowed;
      }
      
      /* Basic utility classes that might be missing */
      .flex { display: flex; }
      .flex-1 { flex: 1; }
      .flex-col { flex-direction: column; }
      .items-center { align-items: center; }
      .justify-center { justify-content: center; }
      .space-y-4 > * + * { margin-top: 1rem; }
      .min-h-\[500px\] { min-height: 500px; }
      .rounded-lg { border-radius: 0.5rem; }
      .rounded-md { border-radius: 0.375rem; }
      .rounded { border-radius: 0.25rem; }
      .p-4 { padding: 1rem; }
      .border { border-width: 1px; }
      
      /* Mermaid Diagram Styles */
      .mermaid-diagram-container {
        overflow-x: auto;
        margin: 20px 0;
      }
      
      .mermaid-diagram-render {
        display: flex;
        justify-content: center;
        margin: 0 auto;
        text-align: center;
      }
      
      /* Override Mermaid SVG styles for better visibility */
      .mermaid svg {
        max-width: 100%;
        height: auto !important;
        margin: 0 auto;
      }
      
      /* Style Mermaid diagram nodes and text */
      .mermaid .node rect, 
      .mermaid .node circle, 
      .mermaid .node ellipse, 
      .mermaid .node polygon {
        fill: #e0f2fe !important;
        stroke: #0284c7 !important;
      }
      
      .mermaid .edgePath .path {
        stroke: #64748b !important;
        stroke-width: 2px !important;
      }
      
      .mermaid .flowchart-link {
        stroke: #64748b !important;
        stroke-width: 2px !important;
      }
      
      .mermaid .label {
        color: #334155 !important;
      }

      /* User menu styles */
      .user-menu {
          position: relative;
          display: inline-block;
      }

      .user-menu-content {
          display: none;
          position: absolute;
          right: 0;
          background-color: white;
          min-width: 200px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          border-radius: 4px;
          padding: 8px 0;
          z-index: 1000;
      }

      .user-menu:hover .user-menu-content {
          display: block;
      }

      .user-menu-item {
          display: block;
          padding: 8px 16px;
          color: #333;
          text-decoration: none;
          transition: background-color 0.3s;
      }

      .user-menu-item:hover {
          background-color: #f5f5f5;
      }

      .user-menu-divider {
          height: 1px;
          background-color: #eee;
          margin: 8px 0;
      }

      .user-profile-btn {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 16px;
          border: none;
          background: none;
          cursor: pointer;
          color: white;
      }

      .user-avatar {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          background-color: #6c5ce7;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 500;
      }

      .sign-in-btn {
          display: flex;
          align-items: center;
          gap: 8px;
          color: white;
          background: none;
          border: none;
          cursor: pointer;
          font-size: 1rem;
          text-decoration: none;
      }

      .sign-in-btn i {
          font-size: 20px;
      }
      
      /* Mermaid diagram styles */
      .mermaid-diagram-container {
          overflow-x: auto;
      }
      .mermaid-diagram-render {
          min-height: 200px;
      }
      .mermaid {
          font-family: 'Roboto', sans-serif;
          max-width: 100%;
      }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <a href="/" class="logo">
                <i class="fas fa-brain"></i>
                <h1>AI Fundamentals</h1>
            </a>
            <nav>
                <ul>
                    <li><a href="/learning.html">Learning</a></li>
                    <li><a href="/ai-tools.html">AI Tools</a></li>
                    <li><a href="/premium.html">Premium</a></li>
                </ul>
            </nav>
            <div id="auth-container">
                <a href="login.html" class="sign-in-btn" id="sign-in-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Sign In</span>
                </a>
                <div class="user-menu" id="user-menu" style="display: none;">
                    <button class="user-profile-btn">
                        <div class="user-avatar" id="user-avatar"></div>
                        <span id="user-email"></span>
                    </button>
                    <div class="user-menu-content">
                        <a href="/account.html" class="user-menu-item">
                            <i class="fas fa-user"></i> My Account
                        </a>
                        <a href="/my-learning.html" class="user-menu-item">
                            <i class="fas fa-graduation-cap"></i> My Learning
                        </a>
                        <a href="/my-games.html" class="user-menu-item premium-item">
                            <i class="fas fa-gamepad"></i> My Games
                        </a>
                        <a href="/my-game-plan.html" class="user-menu-item premium-item">
                            <i class="fas fa-clipboard-list"></i> My Game Plan
                        </a>
                        <a href="/settings.html" class="user-menu-item">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <div class="user-menu-divider"></div>
                        <a href="#" class="user-menu-item" id="sign-out-btn">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            <div class="page-header mb-6"> 
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-3xl font-bold">My Game Plans</h1>
                    <button id="create-new-plan-btn" class="btn-apple py-2 px-4 flex items-center">
                        <i class="fas fa-plus mr-2"></i> Create New Plan
                        </button>
                </div>
                <p class="text-gray-600">Create, save, and refine AI implementation plans for your professional projects.</p> 
                    </div>
                    
            <div id="my-game-plan-root"></div>
            
            <!-- Fallback if React fails to load -->
            <div id="loading-fallback" style="display: flex; justify-content: center; align-items: center; height: 300px;">
                    <div style="text-align: center;">
                        <div class="spinner" style="border: 4px solid rgba(0,0,0,.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #5D3FD3; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        <p style="margin-top: 16px;">Loading Game Plan generator...</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>AI Fundamentals</h3>
                    <p>Your journey to AI mastery starts here</p>
                </div>
                <div class="footer-section">
                    <h3>Resources</h3>
                    <ul>
                        <li><a href="#">Flashcards</a></li>
                        <li><a href="#">Study Guides</a></li>
                        <li><a href="#">Video Lessons</a></li>
                        <li><a href="#">Practice Quizzes</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Company</h3>
                    <ul>
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Contact</a></li>
                        <li><a href="#">Careers</a></li>
                        <li><a href="#">Blog</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Legal</h3>
                    <ul>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Cookie Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 AI Fundamentals. All rights reserved.</p>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <!-- Auth Integration -->
    <script src="js/auth-integration.js"></script>
    <script src="js/stripe-integration.js"></script>
    <script src="js/access-control.js"></script>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjMisQkMgdA6qNg7gnXDumhNOOWOD-Y00",
            authDomain: "ai-fundamentals-ad37d.firebaseapp.com",
            projectId: "ai-fundamentals-ad37d",
            storageBucket: "ai-fundamentals-ad37d.appspot.com",
            messagingSenderId: "668115447112",
            appId: "1:668115447112:web:c0772e9f8c6a498737977d",
            measurementId: "G-2D5V39EQ3T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Auth state observer
        firebase.auth().onAuthStateChanged((user) => {
            const signInBtn = document.getElementById('sign-in-btn');
            const userMenu = document.getElementById('user-menu');
            const userAvatar = document.getElementById('user-avatar');
            const userEmail = document.getElementById('user-email');
            
            if (user) {
                // User is signed in
                console.log('User authenticated, proceeding to render Game Plan');
                signInBtn.style.display = 'none';
                userMenu.style.display = 'block';
                
                // Set user email and avatar
                userEmail.textContent = user.email;
                userAvatar.textContent = user.email[0].toUpperCase();
                
                // Update premium content visibility
                document.querySelectorAll('.premium-content').forEach(elem => {
                    elem.classList.add('unlocked');
                });
                
                // --- Render the React component ONLY if user is logged in ---
                tryRenderGamePlanComponent(); 
                // ---------
            } else {
                // User is signed out
                console.log('User not authenticated, redirecting to login');
                signInBtn.style.display = 'flex';
                userMenu.style.display = 'none';
                
                // Update premium content visibility
                document.querySelectorAll('.premium-content').forEach(elem => {
                    elem.classList.remove('unlocked');
                });
                
                // Redirect to login page since this is a premium feature
                window.location.href = 'login.html?redirect=my-game-plan.html';
            }
        });

        // Sign out functionality
        document.getElementById('sign-out-btn').addEventListener('click', (e) => {
            e.preventDefault();
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Sign out error:', error);
            });
        });
        
        // Initialize user credits if needed
        function initializeUserCreditsIfNeeded(userId) {
            const db = firebase.firestore();
            
            // First check if user document exists
            db.collection('users').doc(userId).get().then((doc) => {
                if (!doc.exists) {
                    // Create the user document first with initial data
                    return db.collection('users').doc(userId).set({
                        credits: 10, // Initial credits for new users
                    });
                }
            }).catch((error) => {
                console.error('Error checking/initializing user credits:', error);
            });
        }
    </script>

    <!-- Load the enhanced game plan JavaScript with cache busting -->
    <script src="my-game-plan-enhanced.js?v=6"></script>

    <!-- Inline Game Plan Component -->
    <script>
      console.log("Starting inline game plan component initialization");
      
      // This will run once the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, checking for React availability");
        
        // Function to initialize when React is available
        function initialize() {
          if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
            console.log("React not available yet, retrying in 200ms");
            setTimeout(initialize, 200);
            return;
          }
          
          console.log("React available, creating Game Plan component");
          
          // A simple game plan component
          function GamePlanApp() {
            // State hooks for form inputs
            const [selectedTopic, setSelectedTopic] = React.useState('');
            const [selectedChallenge, setSelectedChallenge] = React.useState('');
            const [selectedProjectType, setSelectedProjectType] = React.useState('');
            const [description, setDescription] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [gamePlanResult, setGamePlanResult] = React.useState(null);
            
            // --- NEW State for Conversation ---
            const [sessionId, setSessionId] = React.useState(null);
            const [conversation, setConversation] = React.useState([]); // Array of { role: 'user'/'ai'/'system', content: string, type: 'message'/'clarification_request' }
            const [clarificationQuestions, setClarificationQuestions] = React.useState([]);
            const [userInput, setUserInput] = React.useState(''); // For clarification/follow-up input
            // --- End NEW State ---
            
            // --- NEW: Ref for scrolling conversation ---
            const messagesEndRef = React.useRef(null);
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };
            
            React.useEffect(() => {
                // Scroll after state updates and DOM has potentially re-rendered
                setTimeout(scrollToBottom, 100); // Short delay helps ensure DOM update
            }, [conversation]); // Dependency array includes conversation
            
            // State for collapsible sections (true = open)
            const [sectionsOpen, setSectionsOpen] = React.useState({
              'milestones': true,
              'steps': true,
              'technologies': true,
              'resources': true,
              'roadblocks': true,
              'metrics': true,
              'diagram': true, // For Mermaid diagram
              'code': true
            });
            
            // Toggle section visibility
            const toggleSection = (section) => {
              setSectionsOpen(prev => ({
                ...prev,
                [section]: !prev[section]
              }));
            };
            
            // Effect to handle the Mermaid diagram rendering when the game plan result is set
            React.useEffect(() => {
              if (gamePlanResult && gamePlanResult.mermaid_diagram) {
                console.log("Found mermaid diagram:", gamePlanResult.mermaid_diagram);
                
                // Find the diagram container
                const diagramContainer = document.querySelector('.mermaid-diagram-render');
                if (!diagramContainer) {
                  console.error("Diagram container not found");
                  return;
                }
                
                // Clear any previous content
                diagramContainer.innerHTML = '';
                
                // Create message element
                const messageEl = document.createElement('div');
                messageEl.className = 'mb-4 text-gray-700';
                messageEl.textContent = 'Here is the Mermaid diagram code for your implementation:';
                diagramContainer.appendChild(messageEl);
                
                // Create code element
                const preEl = document.createElement('pre');
                preEl.className = 'bg-gray-100 p-4 rounded overflow-auto text-sm';
                
                // Escape HTML for safe display
                const escapeHtml = (unsafe) => {
                  return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
                };
                
                preEl.textContent = gamePlanResult.mermaid_diagram;
                diagramContainer.appendChild(preEl);
                
                // Create note about using the code
                const noteEl = document.createElement('div');
                noteEl.className = 'mt-3 text-sm text-gray-600 italic';
                noteEl.textContent = 'You can copy this code and use it in any Mermaid-enabled editor or website.';
                diagramContainer.appendChild(noteEl);
              }
            }, [gamePlanResult]);
            
            // Get challenges based on topic
            const getChallenges = (topic) => {
              if (!topic) return [];
              
              switch(topic) {
                case 'Introduction to AI':
                  return ['Understanding AI Concepts', 'Machine Learning', 'Natural Language Processing'];
                case 'Office Productivity':
                  return ['Document Automation', 'Email Management', 'Meeting Optimization'];
                case 'Personal Finance':
                  return ['Budgeting', 'Investment Planning', 'Debt Management'];
                case 'Social Media Marketing':
                  return ['Content Calendar Automation', 'Audience Growth Strategies', 'Engagement Optimization'];
                case 'Videography':
                  return ['Video Editing Workflow', 'Content Distribution', 'Audience Growth'];
                case 'eCommerce':
                  return ['Sales Funnel Optimization', 'Product Selection & Sourcing', 'Payment Processing & Checkout'];
                default:
                  return ['Challenge 1', 'Challenge 2', 'Challenge 3'];
              }
            };
            
            // Get project types
            const getProjectTypes = (topic, challenge) => {
              if (!topic || !challenge) return [];
              return ['Personal Project', 'Small Business', 'Enterprise Solution'];
            };
            
            // Reset dependent dropdowns when topic changes
            React.useEffect(() => {
              setSelectedChallenge('');
              setSelectedProjectType('');
            }, [selectedTopic]);
            
            // Reset project type when challenge changes
            React.useEffect(() => {
              setSelectedProjectType('');
            }, [selectedChallenge]);
            
            // Handle form submission (Initial Request)
            const handleSubmit = async (e) => {
              if (e) e.preventDefault();
              const requestDesc = `Generate a game plan for a ${selectedProjectType} about ${selectedTopic} focusing on ${selectedChallenge}.${description ? ` Details: ${description}` : ''}`;
              console.log("Submitting Initial Request:", requestDesc);
              
              setIsLoading(true);
              setError(null);
              setGamePlanResult(null); // Clear previous plan
              setClarificationQuestions([]); // Clear previous questions
              
              // Add user request to conversation history
              setConversation([{ role: 'user', content: requestDesc, type: 'message' }]); 
              
              try {
                if (!firebase.auth().currentUser) {
                  throw new Error("User is not authenticated");
                }
                
                const generateGamePlan = firebase.functions().httpsCallable('generateGamePlan');
                const result = await generateGamePlan({
                  // Initial request data
                  topic: selectedTopic,
                  challenge: selectedChallenge,
                  projectType: selectedProjectType,
                  projectDescription: description || '',
                  // Conversation context
                  sessionId: sessionId,
                  messageType: 'initial_request' 
                });
                
                console.log("Firebase function result:", result);
                
                // Store the returned sessionId in state
                if (result?.data?.sessionId) {
                    setSessionId(result.data.sessionId);
                }
                
                if (result.data.type === 'plan_generated') {
                  setGamePlanResult(result.data.plan);
                   setConversation(prev => [...prev, { role: 'ai', content: 'Here is your generated game plan:', type: 'message' }]);
                  console.log("Game plan generated data:", result.data.plan);
                } else if (result.data.type === 'clarification_needed') {
                  setClarificationQuestions(result.data.questions || []);
                  setConversation(prev => [...prev, { 
                      role: 'ai', 
                      content: `Okay, before I generate the plan, I need a bit more information. Please answer the following question(s):\n${(result.data.questions || []).map(q => `- ${q}`).join('\n')}`, 
                      type: 'clarification_request' 
                  }]);
                  console.log("Clarification needed:", result.data.questions);
                } else {
                   // Handle unexpected response types
                   throw new Error(result.data.error || `Unexpected response type: ${result.data.type}`);
                }
                
              } catch (err) {
                console.error("Error generating game plan:", err);
                const errorMessage = err.message || "Failed to generate game plan. Please check the logs.";
                setError(errorMessage);
                 setConversation(prev => [...prev, { role: 'system', content: `Error: ${errorMessage}`, type: 'error' }]);
              } finally {
                setIsLoading(false);
              }
            };
            
            // --- NEW: Handler to Regenerate Plan ---
            const handleRegeneratePlan = async () => {
                if (!sessionId) {
                    console.error("Cannot regenerate plan without a session ID.");
                    setError("Cannot regenerate plan without a session ID.");
                    return;
                }
                
                console.log(`Regenerating plan for session: ${sessionId} using full history...`);
                setIsLoading(true);
                setError(null);
                setGamePlanResult(null); // Clear current plan display while regenerating
                setClarificationQuestions([]); // Clear any stale questions
                // Add a system message to conversation
                setConversation(prev => [...prev, { 
                    role: 'system', 
                    content: 'Regenerating the full game plan based on the conversation...', 
                    type: 'message' 
                }]);

                try {
                    const generateGamePlan = firebase.functions().httpsCallable('generateGamePlan');
                    // Call the function as if it were an initial request, but provide the sessionId.
                    // The backend function uses the sessionId to load the full history for context.
                    const result = await generateGamePlan({
                        sessionId: sessionId,
                        messageType: 'initial_request' // Treat as initial to get full plan based on history
                        // No topic/challenge/desc needed here as they are in history
                    });

                    console.log("Firebase function result (Regeneration):", result);

                    if (result.data.type === 'plan_generated') {
                        setGamePlanResult(result.data.plan);
                        setConversation(prev => [...prev, { role: 'ai', content: 'Here is the updated game plan:', type: 'message' }]);
                        console.log("Game plan regenerated successfully:", result.data.plan);
                    } else if (result.data.type === 'clarification_needed'){
                        // It's unlikely, but the AI might *still* need clarification after regeneration attempt
                         setClarificationQuestions(result.data.questions || []);
                         setConversation(prev => [...prev, { 
                            role: 'ai', 
                            content: `I still need a bit more information to update the plan fully:\n${(result.data.questions || []).map(q => `- ${q}`).join('\n')}`, 
                            type: 'clarification_request' 
                         }]);
                         console.warn("Clarification still needed after regeneration attempt:", result.data.questions);
                    } else {
                        throw new Error(result.data.error || `Unexpected response type during regeneration: ${result.data.type}`);
                    }

                } catch (err) {
                    console.error("Error regenerating game plan:", err);
                    const errorMessage = err.message || "Failed to regenerate the game plan.";
                    setError(errorMessage);
                    setConversation(prev => [...prev, { role: 'system', content: `Error regenerating: ${errorMessage}`, type: 'error' }]);
                     // Restore previous plan if regeneration fails?
                     // You might want to fetch the last known good plan from history here.
                } finally {
                    setIsLoading(false);
                }
            };
            // --- End NEW Handler ---
            
            // --- NEW Handler Functions ---
            
            const handleClarificationResponse = async () => {
              if (!userInput.trim() || !sessionId || clarificationQuestions.length === 0) return;
              
              const responseText = userInput;
              console.log("Sending Clarification Response:", responseText);
              
              setIsLoading(true);
              setUserInput(''); // Clear input
              setClarificationQuestions([]); // Clear questions
              setConversation(prev => [...prev, { role: 'user', content: responseText, type: 'clarification_response' }]);
              
              try {
                const generateGamePlan = firebase.functions().httpsCallable('generateGamePlan');
                const result = await generateGamePlan({
                  sessionId: sessionId,
                  messageType: 'clarification_response',
                  userResponse: responseText
                });
                
                console.log("Firebase function result (clarification):", result);
                
                // Store the returned sessionId in state (should be the same, but good practice)
                if (result?.data?.sessionId) {
                    setSessionId(result.data.sessionId);
                }
                
                if (result.data.type === 'plan_generated') {
                  setGamePlanResult(result.data.plan);
                  setConversation(prev => [...prev, { role: 'ai', content: 'Thank you! Here is your updated game plan:', type: 'message' }]);
                  console.log("Game plan generated after clarification:", result.data.plan);
                } else {
                  throw new Error(result.data.error || `Unexpected response type after clarification: ${result.data.type}`);
                }
                
              } catch (err) {
                console.error("Error processing clarification response:", err);
                const errorMessage = err.message || "Failed to process your response.";
                setError(errorMessage);
                setConversation(prev => [...prev, { role: 'system', content: `Error: ${errorMessage}`, type: 'error' }]);
              } finally {
                setIsLoading(false);
              }
            };
            
            const handleFollowUp = async () => {
              if (!userInput.trim() || !sessionId || !gamePlanResult) return;
              
              const questionText = userInput;
              console.log("Sending Follow-up Question:", questionText);
              
              setIsLoading(true);
              setUserInput(''); // Clear input
              setConversation(prev => [...prev, { role: 'user', content: questionText, type: 'follow_up_request' }]);
              
              try {
                const generateGamePlan = firebase.functions().httpsCallable('generateGamePlan');
                const result = await generateGamePlan({
                  sessionId: sessionId,
                  messageType: 'follow_up',
                  userResponse: questionText // The user's input is the follow-up question
                });
                
                console.log("Firebase function result (follow-up):", result);
                
                // Store the returned sessionId in state (should be the same)
                if (result?.data?.sessionId) {
                    setSessionId(result.data.sessionId);
                }
                
                if (result.data.type === 'follow_up_answer') {
                  setConversation(prev => [...prev, { role: 'ai', content: result.data.answer, type: 'message' }]);
                  console.log("Follow-up answer received:", result.data.answer);
                  // Note: We are just displaying the answer. The UI doesn't auto-update the plan based on it.
                } else {
                  throw new Error(result.data.error || `Unexpected response type after follow-up: ${result.data.type}`);
                }
                
              } catch (err) {
                console.error("Error processing follow-up question:", err);
                const errorMessage = err.message || "Failed to process your follow-up question.";
                setError(errorMessage);
                 setConversation(prev => [...prev, { role: 'system', content: `Error: ${errorMessage}`, type: 'error' }]);
              } finally {
                setIsLoading(false);
              }
            };
            
            // Render the main component
            const renderDiagramSection = () => {
              // This function is replaced by the diagram section in renderResults
              return null;
            };
            
            // Render the component
            return React.createElement('div', {
              className: 'max-w-4xl mx-auto p-5 font-sans'
            }, [
              React.createElement('h2', {
                className: 'text-3xl font-bold mb-8 text-gray-800'
              }, "Create Your Implementation Game Plan"),
              
              // Form - more subtle highlight when results are shown
              React.createElement('form', {
                onSubmit: handleSubmit,
                className: gamePlanResult ? 'bg-white shadow-lg rounded-lg p-6 mb-10 border-t-4 border-blue-500' : 'bg-white shadow-lg rounded-lg p-6 mb-10' // Use top border highlight
              }, [
                // Topic dropdown
                React.createElement('div', { className: 'grid md:grid-cols-3 gap-5 mb-5' }, [
                  React.createElement('div', {}, [
                    React.createElement('label', {
                      htmlFor: 'topic',
                      className: 'block mb-2 font-medium text-gray-700 text-sm' // Smaller label
                    }, 'Topic'),
                    React.createElement('select', {
                      id: 'topic',
                      value: selectedTopic,
                      onChange: (e) => setSelectedTopic(e.target.value),
                      className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all' // Added focus styles
                    }, [
                      React.createElement('option', { value: '' }, 'Select a topic'),
                      ...['Introduction to AI', 'Office Productivity', 'Personal Finance', 'Social Media Marketing', 'Videography', 'eCommerce'].map(topic => 
                        React.createElement('option', { key: topic, value: topic }, topic)
                      )
                    ])
                  ]),
                  
                  // Challenge dropdown
                  React.createElement('div', {}, [
                    React.createElement('label', {
                      htmlFor: 'challenge',
                      className: 'block mb-2 font-medium text-gray-700 text-sm'
                    }, 'Challenge'),
                    React.createElement('select', {
                      id: 'challenge',
                      value: selectedChallenge,
                      onChange: (e) => setSelectedChallenge(e.target.value),
                      disabled: !selectedTopic,
                      className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all disabled:bg-gray-100 disabled:text-gray-500' // Added disabled styles
                    }, [
                      React.createElement('option', { value: '' }, 'Select a challenge'),
                      ...getChallenges(selectedTopic).map(challenge => 
                        React.createElement('option', { key: challenge, value: challenge }, challenge)
                      )
                    ])
                  ]),
                  
                  // Project Type dropdown
                  React.createElement('div', {}, [
                    React.createElement('label', {
                      htmlFor: 'projectType',
                      className: 'block mb-2 font-medium text-gray-700 text-sm'
                    }, 'Project Type'),
                    React.createElement('select', {
                      id: 'projectType',
                      value: selectedProjectType,
                      onChange: (e) => setSelectedProjectType(e.target.value),
                      disabled: !selectedChallenge,
                      className: 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all disabled:bg-gray-100 disabled:text-gray-500'
                    }, [
                      React.createElement('option', { value: '' }, 'Select a project type'),
                      ...getProjectTypes(selectedTopic, selectedChallenge).map(type => 
                        React.createElement('option', { key: type, value: type }, type)
                      )
                    ])
                  ])
                ]),
                
                // Description textarea
                React.createElement('div', { className: 'mb-5' }, [
                  React.createElement('label', {
                    htmlFor: 'description',
                    className: 'block mb-2 font-medium text-gray-700 text-sm'
                  }, 'Additional Details (Optional)'),
                  React.createElement('textarea', {
                    id: 'description',
                    value: description,
                    onChange: (e) => setDescription(e.target.value),
                    placeholder: 'Provide any context, goals, or constraints for your project...',
                    className: 'w-full p-3 border border-gray-300 rounded-lg min-h-[100px] focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-all'
                  })
                ]),
                
                // Submit button - Enhanced style
                React.createElement('button', {
                  type: 'submit',
                  disabled: !selectedTopic || !selectedChallenge || !selectedProjectType || isLoading,
                  className: 'w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all disabled:opacity-60 disabled:cursor-not-allowed'
                }, isLoading ? 
                  React.createElement('div', { className: 'flex items-center justify-center' }, [
                    React.createElement('svg', { className: 'animate-spin -ml-1 mr-3 h-5 w-5 text-white', xmlns: 'http://www.w3.org/2000/svg', fill: 'none', viewBox: '0 0 24 24' }, [
                      React.createElement('circle', { className: 'opacity-25', cx: '12', cy: '12', r: '10', stroke: 'currentColor', strokeWidth: '4' }),
                      React.createElement('path', { className: 'opacity-75', fill: 'currentColor', d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z' })
                    ]),
                    'Generating Plan...'
                  ]) 
                  : 'Generate Game Plan'
                )
              ]),
              
              // --- NEW: Conversation Area ---
              (conversation.length > 0 || clarificationQuestions.length > 0) && React.createElement('div', {
                className: 'mt-10 mb-8 border border-gray-300 rounded-lg shadow-inner overflow-hidden'
              }, [
                // Conversation Header
                React.createElement('div', {
                  className: 'p-3 bg-gray-100 border-b border-gray-300'
                }, 
                  React.createElement('h3', { className: 'text-lg font-semibold text-gray-700' }, 'Conversation')
                ),
                
                // Message List Area
                React.createElement('div', {
                  className: 'p-4 space-y-4 max-h-96 overflow-y-auto bg-white',
                  style: { scrollBehavior: 'smooth' },
                  id: 'conversation-messages' // Add ID for potential direct manipulation if needed
                }, [
                  conversation.map((msg, index) => 
                    React.createElement('div', { 
                      key: index, 
                      className: `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}` 
                    }, [
                      React.createElement('div', {
                        className: `p-3 rounded-lg max-w-[80%] whitespace-pre-wrap ${ 
                          msg.role === 'user' ? 'bg-blue-500 text-white' : 
                          msg.role === 'ai' ? 'bg-gray-200 text-gray-800' : 
                          'bg-red-100 text-red-700 italic' // System/Error messages
                        }`
                      }, msg.content)
                    ])
                  ),
                  // Improved Loading indicator
                  isLoading && React.createElement('div', { className: 'flex justify-start' }, [
                    React.createElement('div', {
                      className: 'p-3 rounded-lg bg-gray-200 text-gray-600 italic flex items-center'
                    }, [
                       // Simple pulsing dots animation
                       React.createElement('span', { className: 'animate-pulse inline-block w-2 h-2 bg-gray-500 rounded-full mr-1' }),
                       React.createElement('span', { className: 'animate-pulse delay-150 inline-block w-2 h-2 bg-gray-500 rounded-full mr-1' }),
                       React.createElement('span', { className: 'animate-pulse delay-300 inline-block w-2 h-2 bg-gray-500 rounded-full mr-2' }),
                       'AI is thinking...'
                    ])
                  ]),
                  // --- NEW: Add empty div for scrolling target ---
                  React.createElement('div', { ref: messagesEndRef })
                  // --- End NEW ---
                ]),
                
                // Input Area (for clarification/follow-up)
                (clarificationQuestions.length > 0 || gamePlanResult) && !isLoading && React.createElement('div', {
                  className: 'p-3 bg-gray-50 border-t border-gray-300 flex items-center space-x-2 flex-wrap' // Added flex-wrap
                }, [
                  React.createElement('input', {
                    type: 'text',
                    value: userInput,
                    onChange: (e) => setUserInput(e.target.value),
                    placeholder: clarificationQuestions.length > 0 ? 'Type your answer here...' : 'Ask a follow-up question...',
                    className: 'flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 min-w-[200px]', // Added min-width
                    onKeyPress: (e) => {
                        if (e.key === 'Enter' && userInput.trim()) {
                            if (clarificationQuestions.length > 0) {
                                handleClarificationResponse();
                            } else if (gamePlanResult) {
                                handleFollowUp();
                            }
                        }
                    }
                  }),
                  React.createElement('button', {
                    onClick: () => {
                       if (clarificationQuestions.length > 0) {
                         handleClarificationResponse();
                       } else if (gamePlanResult) {
                         handleFollowUp();
                       }
                    },
                    disabled: !userInput.trim() || isLoading,
                    className: 'bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 whitespace-nowrap' // Added whitespace-nowrap
                  }, clarificationQuestions.length > 0 ? 'Send Answer' : 'Ask Follow-up'),
                  // --- NEW: Regenerate Button ---
                  gamePlanResult && !clarificationQuestions.length > 0 && React.createElement('button', {
                    onClick: handleRegeneratePlan,
                    disabled: isLoading,
                    className: 'bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:opacity-50 whitespace-nowrap ml-auto' // Added ml-auto
                  }, 'Update Plan with Chat Feedback')
                  // --- End Regenerate Button ---
                ])
              ]),
              // --- End NEW Conversation Area ---
              
              // Error display - More prominent
              error && React.createElement('div', {
                className: 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-8 shadow'
              }, [
                React.createElement('div', { className: 'font-bold mb-1' }, 'Error Generating Plan'),
                React.createElement('div', {}, error)
              ]),
              
              // Results section - Main container for results
              gamePlanResult && React.createElement('div', {
                className: 'results-container space-y-8' // Add space between sections
              }, [
                React.createElement('h2', {
                  className: 'text-3xl font-bold text-gray-800 border-b pb-3 mb-6'
                }, 'Your Generated Project Plan'),
                
                // Project summary - Styled as a callout
                React.createElement('div', { className: 'p-5 bg-blue-50 border border-blue-200 rounded-lg mb-8' }, [
                  React.createElement('h3', { className: 'text-xl font-semibold text-blue-800 mb-2'}, 'Project Summary'),
                  React.createElement('p', {
                    className: 'text-gray-700 text-lg'
                  }, gamePlanResult.project_summary || gamePlanResult.project_description)
                ]),
                
                // --- REORDERED SECTIONS --- 
                
                // 1. Mermaid diagram section (if available)
                gamePlanResult.mermaid_diagram && React.createElement(CollapsibleSection, { 
                  sectionKey: 'diagram', 
                  title: 'Architecture/Flow Diagram', 
                  content: gamePlanResult.mermaid_diagram,
                  isOpenByDefault: true
                }),
                  
                // 2. Collapsible milestones section
                React.createElement(CollapsibleSection, { 
                  sectionKey: 'milestones', 
                  title: 'Key Milestones', 
                  content: gamePlanResult.key_milestones,
                  isOpenByDefault: true
                }),
                  
                // 3. Collapsible steps section
                React.createElement(CollapsibleSection, { 
                  sectionKey: 'steps', 
                  title: 'Implementation Steps', 
                  content: gamePlanResult.suggested_steps,
                  isOpenByDefault: true
                }),
                  
                // 4. Collapsible technologies section
                React.createElement(CollapsibleSection, { 
                  sectionKey: 'technologies', 
                  title: 'Recommended Technologies', 
                  content: gamePlanResult.recommended_technologies,
                  isOpenByDefault: true
                }),
                  
                // 5. Collapsible resources section
                React.createElement(CollapsibleSection, { 
                  sectionKey: 'resources', 
                  title: 'Learning Resources', 
                  content: gamePlanResult.learning_resources,
                  isOpenByDefault: true
                }),
                  
                // 6. Collapsible roadblocks section
                React.createElement(CollapsibleSection, { 
                  sectionKey: 'roadblocks', 
                  title: 'Potential Roadblocks', 
                  content: gamePlanResult.potential_roadblocks,
                  isOpenByDefault: true
                }),
                  
                // 7. Collapsible metrics section
                React.createElement(CollapsibleSection, { 
                  sectionKey: 'metrics', 
                  title: 'Success Metrics', 
                  content: gamePlanResult.success_metrics,
                  isOpenByDefault: true
                }),
                  
                // 8. Code snippets section (if available)
                gamePlanResult.code_snippets && gamePlanResult.code_snippets.length > 0 && React.createElement(CollapsibleSection, { 
                  sectionKey: 'code', 
                  title: 'Sample Code Snippets', 
                  content: gamePlanResult.code_snippets,
                  isOpenByDefault: true
                })
              ])
            ]);
          }
          
          try {
            // Get the root element
            const rootElement = document.getElementById('my-game-plan-root');
            
            if (!rootElement) {
              console.error("Root element not found");
              return;
            }
            
            // Hide the loading indicator
            const loadingEl = document.getElementById('loading-fallback');
            if (loadingEl) loadingEl.style.display = 'none';
            
            // Render our component
            ReactDOM.render(
              React.createElement(GamePlanApp, null),
              rootElement
            );
            
            console.log('Game Plan component rendered successfully!');
          } catch (err) {
            console.error("Error rendering game plan:", err);
          }
        }
        
        // Start the initialization process
        initialize();
      });
      
      // Define the tryRenderGamePlanComponent function that's called by the auth observer
      function tryRenderGamePlanComponent() {
        console.log("Auth verified, DOM content loaded, will initialize component");
        // This function is intentionally empty since the component will be initialized by the DOMContentLoaded event
      }

      // --- NEW: Define CollapsibleSection component outside of the main component ---
      // Function to render a collapsible section - moved outside of main component to fix hooks error
      function CollapsibleSection({ title, content, isOpenByDefault = true, sectionKey }) {
        const [isOpen, setIsOpen] = React.useState(isOpenByDefault);
        
        // Icon mapping for different section types - updated with Font Awesome icons
        const iconMap = {
          diagram: '<i class="fas fa-project-diagram text-blue-600"></i>',
          milestones: '<i class="fas fa-flag-checkered text-green-600"></i>',
          steps: '<i class="fas fa-tasks text-indigo-600"></i>',
          technologies: '<i class="fas fa-laptop-code text-purple-600"></i>',
          resources: '<i class="fas fa-book text-yellow-600"></i>',
          roadblocks: '<i class="fas fa-exclamation-triangle text-red-600"></i>',
          metrics: '<i class="fas fa-chart-line text-teal-600"></i>',
          code: '<i class="fas fa-code text-gray-700"></i>'
        };
        
        // UseEffect hook to render Mermaid diagram when the component is visible
        React.useEffect(() => {
          if (sectionKey === 'diagram' && isOpen && content) {
            const renderDiagram = () => {
              try {
                const container = document.querySelector('.mermaid-diagram-render');
                if (!container) return;
                
                // Clear previous content
                container.innerHTML = '';
                
                // Create a new div for mermaid to render into
                const diagramDiv = document.createElement('div');
                diagramDiv.className = 'mermaid';
                diagramDiv.textContent = content;
                container.appendChild(diagramDiv);
                
                // Run mermaid rendering
                if (window.mermaid) {
                  console.log('Rendering diagram with mermaid');
                  window.mermaid.run({
                    nodes: [diagramDiv]
                  }).catch(err => {
                    console.error('Mermaid rendering error:', err);
                    // If rendering fails, show the code
                    showDiagramCode();
                  });
                } else {
                  console.error('Mermaid library not available');
                  showDiagramCode();
                }
              } catch (err) {
                console.error('Error rendering diagram:', err);
                showDiagramCode();
              }
            };
            
            // Fallback to show code if rendering fails
            const showDiagramCode = () => {
              const container = document.querySelector('.mermaid-diagram-render');
              if (!container) return;
              
              container.innerHTML = '';
              
              // Add explanation
              const messageEl = document.createElement('div');
              messageEl.className = 'mb-4 text-gray-700';
              messageEl.textContent = 'Here is the Mermaid diagram code for your implementation:';
              container.appendChild(messageEl);
              
              // Add code in preformatted block
              const preEl = document.createElement('pre');
              preEl.className = 'bg-gray-100 p-4 rounded-lg overflow-auto text-sm font-mono';
              preEl.textContent = content;
              container.appendChild(preEl);
              
              // Add note about using the code
              const noteEl = document.createElement('div');
              noteEl.className = 'mt-3 text-sm text-gray-600 italic';
              noteEl.textContent = 'You can copy this code and use it in any Mermaid-enabled editor or website.';
              container.appendChild(noteEl);
            };
            
            // Render diagram with slight delay to ensure DOM is ready
            setTimeout(renderDiagram, 100);
          }
        }, [isOpen, content, sectionKey]);
        
        // Render content based on type and section key
        const renderContent = () => {
          // Special handling for mermaid diagrams
          if (sectionKey === 'diagram') {
            return React.createElement('div', {
              className: 'mt-3 bg-white p-4 rounded-lg border',
            }, [
              React.createElement('div', {
                className: 'mermaid-diagram-container',
                style: { minHeight: '200px' }
              }, [
                React.createElement('div', {
                  className: 'mermaid-diagram-render',
                  style: { width: '100%' },
                  dangerouslySetInnerHTML: { __html: '<div class="flex justify-center items-center h-full"><div class="spinner" style="border: 4px solid rgba(0,0,0,.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s linear infinite;"></div></div>' }
                })
              ])
            ]);
          }
          
          // For array content (most sections)
          if (Array.isArray(content)) {
            // Check if array contains objects (for most structured data)
            if (content.length > 0 && typeof content[0] === 'object') {
              const items = content.map((item, index) => {
                // Handle different item formats based on section type
                let itemContent;
                
                if (['milestones', 'steps', 'roadblocks'].includes(sectionKey)) {
                  // Format for items with title and description
                  itemContent = [
                    React.createElement('span', { className: 'font-semibold' }, 
                      `${index + 1}. ${item.title || item.milestone || item.step || item.roadblock || ''}`
                    ),
                    item.description && React.createElement('p', { className: 'text-gray-600 mt-1 ml-5' }, 
                      item.description
                    )
                  ];
                } else if (sectionKey === 'technologies') {
                  // Format for technology items
                  itemContent = [
                    React.createElement('span', { className: 'font-semibold text-blue-600' }, 
                      item.name || ''
                    ),
                    (item.reason || item.reasoning) && React.createElement('p', { className: 'text-gray-600 mt-1 ml-5' }, 
                      item.reason || item.reasoning
                    )
                  ];
                } else if (sectionKey === 'resources') {
                  // Format for resource items
                  itemContent = [
                    React.createElement('a', { 
                      href: item.url || '#',
                      target: '_blank',
                      className: 'text-blue-600 hover:underline font-medium'
                    }, item.title || 'Resource'),
                    (item.description || item.relevance) && React.createElement('p', { className: 'text-gray-600 mt-1 ml-5' }, 
                      item.description || item.relevance
                    )
                  ];
                } else if (sectionKey === 'code') {
                  // Format for code snippets
                  itemContent = [
                    React.createElement('span', { className: 'font-semibold' }, 
                      item.title || item.description || 'Code Sample'
                    ),
                    React.createElement('pre', { 
                      className: 'bg-gray-100 p-3 rounded mt-2 overflow-x-auto text-sm font-mono' 
                    }, item.code || '')
                  ];
                } else if (sectionKey === 'metrics') {
                  // Format for metrics
                  itemContent = [
                    React.createElement('span', { className: 'font-semibold' }, 
                      item.metric || item.title || ''
                    )
                  ];
                } else {
                  // Generic format for other object arrays
                  itemContent = [
                    React.createElement('span', { className: 'font-semibold' }, 
                      item.title || item.name || ''
                    ),
                    (item.description || item.detail) && React.createElement('p', { className: 'text-gray-600 mt-1 ml-5' }, 
                      item.description || item.detail || ''
                    )
                  ];
                }
                
                return React.createElement('li', { 
                  key: index, 
                  className: 'mb-3 pb-2 border-b border-gray-100 last:border-0'
                }, itemContent);
              });
              
              // Use ul container for list items
              return React.createElement('ul', { className: 'mt-3 list-none' }, items);
            } else {
              // Simple string array
              const items = content.map((item, index) => 
                React.createElement('li', { 
                  key: index,
                  className: 'mb-2'
                }, `${index + 1}. ${item}`)
              );
              
              return React.createElement('ul', { className: 'mt-3 list-disc pl-5' }, items);
            }
          }
          
          // For string content (like description)
          return React.createElement('div', { className: 'mt-3 text-gray-700' }, content);
        };
        
        // Main container
        return React.createElement('div', {
          className: 'mb-4 bg-gray-50 rounded-lg shadow-sm overflow-hidden'
        }, [
          // Header
          React.createElement('div', {
            className: 'flex items-center justify-between p-4 cursor-pointer bg-gray-100 hover:bg-gray-200',
            onClick: () => setIsOpen(!isOpen)
          }, [
            React.createElement('h3', {
              className: 'text-lg font-medium flex items-center'
            }, [
              React.createElement('span', { 
                className: 'mr-2 w-6 text-center',
                dangerouslySetInnerHTML: { __html: iconMap[sectionKey] || '<i class="fas fa-file-alt text-gray-600"></i>' }
              }),
              title
            ]),
            React.createElement('span', {
              className: 'text-gray-500 text-xl transition-transform duration-200',
              style: { transform: isOpen ? 'rotate(180deg)' : 'rotate(0deg)' }
            }, '▼')
          ]),
          
          // Content
          React.createElement('div', {
            className: 'transition-all duration-300 overflow-hidden',
            style: {
              maxHeight: isOpen ? '2000px' : '0px',
              opacity: isOpen ? 1 : 0,
              padding: isOpen ? '1rem' : '0 1rem'
            }
          }, renderContent())
        ]);
      }
      // --- END NEW COMPONENT --- 
    </script>

    <!-- Fallback script if the main one fails to load -->
    <script>
        // Hide any errors and just show the component
        setTimeout(function() {
          const rootElement = document.getElementById('my-game-plan-root');
          const loadingEl = document.getElementById('loading-fallback');
          
          // If loading indicator is still visible after 3 seconds, hide it
          if (loadingEl && loadingEl.style.display !== 'none') {
            loadingEl.style.display = 'none';
            console.log("Force hiding loading indicator after timeout");
            
            // If root is empty, show a basic message
            if (!rootElement.hasChildNodes()) {
              rootElement.innerHTML = `
                <div class="text-center p-6 bg-white shadow-lg rounded-lg">
                  <h2 class="text-2xl font-bold mb-4">Game Plan Generator</h2>
                  <p class="mb-4">Create, save, and refine AI implementation plans for your professional projects.</p>
                  <button onclick="window.location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh Page
                  </button>
                </div>
              `;
            }
          }
        }, 3000);
    </script>

    <!-- Sample challenges based on topic - updated with business-focused challenges -->
    <script>
      const getChallenges = (topic) => {
        if (!topic) return [];
        
        switch(topic) {
          case 'eCommerce':
            return [
              'Sales Funnel Optimization',
              'Product Selection & Sourcing',
              'Payment Processing & Checkout',
              'Customer Retention & Loyalty',
              'Inventory Management',
              'Marketing Automation',
              'Order Fulfillment',
              'Abandoned Cart Recovery'
            ];
          case 'Introduction to AI':
            return [
              'Customer Service Automation',
              'Content Generation',
              'Data Analysis & Insights',
              'Personalization Engines',
              'Predictive Forecasting'
            ];
          case 'Office Productivity':
            return [
              'Document Automation',
              'Meeting Optimization',
              'Email Management',
              'Process Streamlining',
              'Team Collaboration'
            ];
          case 'Personal Finance':
            return [
              'Budgeting & Expense Tracking',
              'Investment Planning',
              'Debt Management',
              'Retirement Planning',
              'Tax Optimization'
            ];
          case 'Social Media Marketing':
            return [
              'Content Calendar Automation',
              'Audience Growth Strategies',
              'Engagement Optimization',
              'Ad Campaign Management',
              'Performance Analytics'
            ];
          case 'Videography':
            return [
              'Video Editing Workflow',
              'Content Distribution',
              'Audience Growth',
              'Monetization Strategies',
              'Equipment Selection'
            ];
          default:
            return [
              'Workflow Automation',
              'Customer Engagement',
              'Revenue Optimization',
              'Cost Reduction',
              'Data Analysis'
            ];
        }
      };

      // Sample project types based on business goals
      const getProjectTypes = (topic, challenge) => {
        if (!topic || !challenge) return [];
        
        return [
          'Personal Project', 
          'Small Business', 
          'Enterprise Solution'
        ];
      };
    </script>
</body>
</html>
